<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JOLI PAS CHER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:wght@400;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Playfair Display', serif;
      background: linear-gradient(135deg, #4A4A4A 0%, #6B5B45 50%, #8B7355 100%);
      min-height: 100vh;
      color: #fff;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Cinzel', serif;
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }

    .gold-text {
      color: #FFD700;
      font-weight: 700;
    }

    .btn-primary {
      background: #8B7355;
      color: #FFD700;
      border: 2px solid #FFD700;
      font-weight: 700;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #FFD700;
      color: #2c2420;
      transform: scale(1.05);
    }

    .card {
      background: rgba(90, 90, 90, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 15px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Geometry Dash Game */
    #game-canvas {
      background: #2D2D2D;
      border: 3px solid #FFD700;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    /* Rarity styles */
    .rarity-nul {
      border: 2px solid #666;
      background: linear-gradient(135deg, rgba(102, 102, 102, 0.3), rgba(74, 74, 74, 0.3));
    }

    .rarity-basique {
      border: 2px solid #4a9eff;
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.3), rgba(30, 144, 255, 0.3));
    }

    .rarity-rare {
      border: 2px solid #9945ff;
      background: linear-gradient(135deg, rgba(153, 69, 255, 0.3), rgba(138, 43, 226, 0.3));
    }

    .rarity-goat {
      border: 2px solid #FFD700;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 165, 0, 0.4));
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
      animation: goat-glow 2s ease-in-out infinite;
    }

    @keyframes goat-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
      50% { box-shadow: 0 0 35px rgba(255, 215, 0, 0.9); }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal-content {
      background: #4a4a4a;
      border: 2px solid #FFD700;
      border-radius: 15px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen" style="position: fixed; inset: 0; z-index: 10000; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #4A4A4A 0%, #6B5B45 50%, #8B7355 100%);">
  <div style="text-align: center;">
    <img src="https://i.postimg.cc/9Xx6XHrD/Screenshot-20250525-094331.png" alt="Logo" style="width: 128px; height: 128px; margin: 0 auto 2rem; animation: bounce 1s infinite;">
    <h1 style="font-size: 3rem; font-family: 'Cinzel', serif; color: #FFD700; margin-bottom: 1rem;">JOLI PAS CHER</h1>
    <p style="font-size: 1.25rem; color: #FFD700; margin-bottom: 2rem;">Chargement en cours...</p>
    <div style="display: flex; justify-content: center; gap: 0.5rem;">
      <div style="width: 16px; height: 16px; background: #FFD700; border-radius: 50%; animation: pulse 1.5s ease-in-out infinite;"></div>
      <div style="width: 16px; height: 16px; background: #FFD700; border-radius: 50%; animation: pulse 1.5s ease-in-out 0.2s infinite;"></div>
      <div style="width: 16px; height: 16px; background: #FFD700; border-radius: 50%; animation: pulse 1.5s ease-in-out 0.4s infinite;"></div>
    </div>
  </div>
</div>

<!-- Header -->
<header style="position: sticky; top: 0; z-index: 50; background: rgba(75, 64, 55, 0.95); backdrop-filter: blur(10px); box-shadow: 0 4px 6px rgba(0,0,0,0.3); border-bottom: 2px solid #FFD700;">
  <div style="max-width: 1280px; margin: 0 auto; padding: 1rem; display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <img src="https://i.postimg.cc/9Xx6XHrD/Screenshot-20250525-094331.png" alt="Logo" style="height: 48px; width: 48px; object-fit: contain;">
      <h1 class="gold-text" style="font-size: 1.5rem;">JOLI PAS CHER</h1>
    </div>

    <button onclick="toggleMenu()" style="padding: 0.5rem; border-radius: 0.5rem; background: rgba(255, 215, 0, 0.2); border: 1px solid #FFD700; cursor: pointer;">
      <svg style="width: 24px; height: 24px; color: #FFD700;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>

  <!-- Menu -->
  <div id="menu" style="display: none; background: rgba(44, 36, 32, 0.95); backdrop-filter: blur(10px);">
    <div style="max-width: 1280px; margin: 0 auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
      <button onclick="showSection('accueil')" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left;">ğŸ  Accueil</button>
      <button onclick="showSection('boutique')" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left;">ğŸ›ï¸ Boutique</button>
      <button onclick="showSection('panier')" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left;">ğŸ›’ Panier</button>
      <button onclick="showSection('bibliotheque')" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left;">ğŸ“š BibliothÃ¨que</button>
      <button onclick="showSection('classement')" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left;">ğŸ† Classement</button>
      <button onclick="showSection('jeu')" class="btn-primary" style="padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left;">ğŸ® Jeu</button>
      <button id="messages-menu-btn" onclick="showSection('messages')" class="btn-primary" style="display: none; padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left; position: relative;">ğŸ’¬ Messages</button>
      <button id="admin-menu-btn" onclick="showSection('admin')" class="btn-primary" style="display: none; padding: 0.75rem 1rem; border-radius: 0.5rem; text-align: left; background: #8B0000;">âš™ï¸ Administrateur</button>
    </div>
  </div>
</header>

<main style="max-width: 1280px; margin: 0 auto; padding: 2rem 1rem;">

  <!-- Section Accueil -->
  <section id="accueil" class="section active">
    <div style="text-align: center; margin-bottom: 3rem;">
      <h1 class="gold-text" style="font-size: 2.5rem; margin-bottom: 1rem;">Bienvenue sur Joli Pas Cher</h1>
      <p style="font-size: 1.5rem; color: #FFD700; opacity: 0.9;">DÃ©couvrez des produits <strong>uniques</strong> Ã  petit prix !</p>
    </div>

    <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
      <a href="https://poe.com/Har22fragpt" target="_blank" class="btn-primary" style="padding: 1rem 2rem; border-radius: 0.5rem; text-decoration: none; display: inline-block; font-size: 1.125rem; text-transform: uppercase;">
        ğŸ’¬ Discute avec le S (sur Poe)
      </a>
    </div>

    <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
      <iframe
        src="https://www.instagram.com/reel/DGvmGEgNK-c/embed/?autoplay=1&hidecaption=1&controls=0"
        width="400"
        height="350"
        frameborder="0"
        scrolling="no"
        allow="autoplay; encrypted-media"
        style="border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 100%;">
      </iframe>
    </div>

    <div class="card" style="padding: 2rem;">
      <h2 class="gold-text" style="text-align: center; margin-bottom: 1.5rem; font-size: 2rem;">ğŸµ Meilleures Musiques</h2>

      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 1rem;">
          <h3 style="font-size: 1.125rem; font-weight: 600; color: #FFD700; margin-bottom: 0.5rem;">Frank le bÅ“uf</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1omwth55KSLT?autoplay=1" frameborder="0" allow="autoplay" style="border-radius: 5px;"></iframe>
        </div>

        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 1rem;">
          <h3 style="font-size: 1.125rem; font-weight: 600; color: #FFD700; margin-bottom: 0.5rem;">Band organise samba</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1ghiDBHLVRtn?autoplay=0" frameborder="0" allow="autoplay" style="border-radius: 5px;"></iframe>
        </div>

        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 1rem;">
          <h3 style="font-size: 1.125rem; font-weight: 600; color: #FFD700; margin-bottom: 0.5rem;">Journal 2 20h02</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1bKOLORGf4GO?autoplay=0" frameborder="0" allow="autoplay" style="border-radius: 5px;"></iframe>
        </div>

        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 1rem;">
          <h3 style="font-size: 1.125rem; font-weight: 600; color: #FFD700; margin-bottom: 0.5rem;">Vendez votre Frank LebÅ“uf</h3>
          <iframe width="100%" height="60" src="https://vocaroo.com/embed/1fLLgpWY9xxo?autoplay=0" frameborder="0" allow="autoplay" style="border-radius: 5px;"></iframe>
        </div>
      </div>
    </div>
  </section>

  <!-- Section Boutique -->
  <section id="boutique" class="section">
    <div style="margin-bottom: 2rem; text-align: center;">
      <input
        type="text"
        id="recherche"
        oninput="filtrerArticles()"
        placeholder="ğŸ” Rechercher un article..."
        style="width: 100%; max-width: 500px; padding: 0.75rem 1.5rem; border-radius: 50px; border: 2px solid #FFD700; background: rgba(107, 93, 82, 0.5); color: #FFD700; font-size: 16px; outline: none;">
    </div>

    <div style="text-align: center; margin-bottom: 2rem;">
      <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ Ouvrir des Packs</h3>
      <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
        <button onclick="ouvrirPack('basique')" class="btn-primary" style="padding: 1rem 1.5rem; border-radius: 0.5rem; font-size: 1rem;">
          ğŸ“¦ Pack Basique - 100 cailloux
        </button>
        <button onclick="ouvrirPack('rare')" class="btn-primary" style="padding: 1rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; background: #9945ff;">
          ğŸ’ Pack Rare - 500 cailloux
        </button>
        <button onclick="ouvrirPack('goat')" class="btn-primary" style="padding: 1rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; background: #FFD700; color: #000;">
          ğŸ‘‘ Pack GOAT - 2000 cailloux
        </button>
      </div>
      <p style="color: #FFD700; margin-top: 0.5rem; font-size: 0.875rem;">Taux de drop: Nul 50% | Basique 30% | Rare 19% | GOAT 1%</p>
    </div>

    <div id="articles-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;"></div>
  </section>

  <!-- Section Panier -->
  <section id="panier" class="section">
    <h2 class="gold-text" style="text-align: center; font-size: 2.5rem; margin-bottom: 2rem;">ğŸ›’ Votre panier</h2>

    <!-- Login Section -->
    <div id="login-section" style="margin-bottom: 2rem;">
      <div class="card" style="padding: 2rem; text-align: center;">
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ” Connexion rapide par QR Code</h3>
        <p style="color: #FFD700; margin-bottom: 1.5rem;">Scannez votre QR code personnel pour vous connecter automatiquement !</p>
        <button onclick="startQRScanner()" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 50px; font-size: 1rem;">
          ğŸ“· Scanner QR Code
        </button>
      </div>

      <div style="text-align: center; margin-top: 1.5rem;">
        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button onclick="toggleClassicLogin()" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 0.5rem;">
            ğŸ”‘ Connexion
          </button>
          <button onclick="toggleSignup()" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 0.5rem;">
            âœ¨ CrÃ©er un compte
          </button>
        </div>

        <form id="classic-login-form" style="display: none; margin-top: 1rem; max-width: 400px; margin-left: auto; margin-right: auto;" class="card" onsubmit="handleClassicLogin(event)">
          <div style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
            <h3 class="gold-text" style="text-align: center; margin-bottom: 0.5rem;">ğŸ”‘ Connexion</h3>
            <input name="identifiant" type="text" placeholder="Identifiant" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <input name="motDePasse" type="password" placeholder="Mot de passe" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <button type="submit" class="btn-primary" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem;">Se connecter</button>
            <div id="login-error" style="color: #ff6b6b; font-size: 0.875rem;"></div>
          </div>
        </form>

        <form id="signup-form" style="display: none; margin-top: 1rem; max-width: 400px; margin-left: auto; margin-right: auto;" class="card" onsubmit="handleSignup(event)">
          <div style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
            <h3 class="gold-text" style="text-align: center; margin-bottom: 0.5rem;">âœ¨ CrÃ©er un compte</h3>
            <input name="identifiant" type="text" placeholder="Identifiant (MAJUSCULES)" required pattern="[A-Z]+" title="Uniquement des lettres majuscules" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <input name="email" type="email" placeholder="Email" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <input name="motDePasse" type="password" placeholder="Mot de passe (min. 4 caractÃ¨res)" required minlength="4" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <input name="confirmMotDePasse" type="password" placeholder="Confirmer le mot de passe" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <button type="submit" class="btn-primary" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem;">CrÃ©er mon compte</button>
            <div id="signup-error" style="color: #ff6b6b; font-size: 0.875rem;"></div>
            <div id="signup-success" style="color: #51cf66; font-size: 0.875rem;"></div>
          </div>
        </form>
      </div>
    </div>

    <!-- QR Scanner Overlay -->
    <div id="qr-scanner-overlay" style="display: none;" class="modal-overlay">
      <div class="modal-content">
        <h3 class="gold-text" style="margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">ğŸ” Scanner votre QR Code</h3>
        <div style="position: relative; width: 100%; max-width: 400px; margin: 0 auto 1.5rem;">
          <div style="position: relative; border: 4px solid #51cf66; border-radius: 15px; overflow: hidden; aspect-ratio: 1;">
            <video id="qr-video" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
            <canvas id="qr-canvas" style="display: none;"></canvas>
          </div>
        </div>
        <p id="scan-message" style="text-align: center; color: #FFD700; font-weight: 600; margin-bottom: 1rem;">Initialisation...</p>
        <button onclick="stopQRScanner()" class="btn-primary" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; background: #8B0000;">
          âŒ Fermer
        </button>
      </div>
    </div>

    <!-- QR Code Verification Overlay -->
    <div id="qr-code-verification-overlay" style="display: none;" class="modal-overlay">
      <div class="modal-content">
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ”’ VÃ©rification du code secret</h3>
        <p id="qr-user-prompt" style="color: #FFD700; margin-bottom: 1.5rem;">Veuillez entrer votre code secret.</p>
        <form id="qr-verify-form" onsubmit="handleQRVerify(event)" style="display: flex; flex-direction: column; gap: 1rem;">
          <input type="password" id="qr-secret-code" placeholder="Code Secret" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
          <button type="submit" class="btn-primary" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem;">Valider le Code</button>
          <div id="qr-verify-error" style="color: #ff6b6b; font-size: 0.875rem;"></div>
        </form>
        <button onclick="cancelQRVerify()" class="btn-primary" style="width: 100%; margin-top: 1rem; padding: 0.5rem; border-radius: 0.5rem; background: #8B0000;">
          âŒ Annuler
        </button>
      </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" style="display: none; margin-bottom: 2rem;">
      <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="color: #FFD700;">
            <p style="font-size: 1.125rem;">âœ… ConnectÃ© en tant que: <strong id="user-name" class="gold-text"></strong></p>
            <p style="font-size: 1.125rem;">ğŸ’° Solde: <strong id="user-balance" class="gold-text"></strong> cailloux</p>
          </div>
          <button onclick="logout()" class="btn-primary" style="padding: 0.5rem 1rem; border-radius: 0.5rem; background: #8B0000;">
            ğŸšª DÃ©connexion
          </button>
        </div>
      </div>

      <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 class="gold-text" style="font-size: 1.25rem; margin-bottom: 1rem;">ğŸ’¸ Envoyer des cailloux</h3>
        <form onsubmit="envoyerCailloux(event)" style="display: flex; flex-direction: column; gap: 0.75rem;">
          <input name="destinataire" type="text" placeholder="Identifiant du destinataire" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
          <input name="montant" type="number" placeholder="Montant" min="1" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
          <button type="submit" class="btn-primary" style="padding: 0.5rem 1rem; border-radius: 0.5rem;">Envoyer</button>
        </form>
      </div>

      <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 class="gold-text" style="font-size: 1.25rem; margin-bottom: 1rem;">ğŸ« Code CrÃ©ateur</h3>
        <input type="text" placeholder="Entrez le code crÃ©ateur" onkeypress="handleCodeInput(event)" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        <div id="code-success" style="display: none; margin-top: 0.75rem; color: #51cf66; font-weight: bold;"></div>
      </div>
    </div>

    <!-- Cart Content -->
    <div class="card" style="padding: 2rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
        <h3 class="gold-text" style="font-size: 1.5rem;">ğŸ›’ Articles dans le panier</h3>
        <button id="clear-cart-button" onclick="viderPanier()" style="display: none; padding: 0.5rem 1rem; border-radius: 0.5rem; background: #8B0000; color: #FFD700; border: 1px solid #FFD700; cursor: pointer;">
          ğŸ—‘ï¸ Vider
        </button>
      </div>
      <div id="empty-cart" style="text-align: center; color: rgba(255, 215, 0, 0.7); font-style: italic; padding: 2rem;">Votre panier est vide</div>
      <ul id="liste-panier" style="display: none; list-style: none; margin-bottom: 1.5rem;"></ul>
      <p id="total-panier" style="display: none; font-size: 1.5rem; font-weight: bold; color: #FFD700; text-align: center; margin-bottom: 1.5rem;">Total : 0 cailloux</p>
      <button id="buy-button" onclick="acheter()" style="display: none; width: 100%; padding: 1rem; border-radius: 50px; background: #8B7355; color: #FFD700; border: 2px solid #FFD700; font-weight: bold; font-size: 1.125rem; cursor: pointer;">
        ğŸ’³ Acheter
      </button>
    </div>

    <!-- Historique des commandes -->
    <div id="order-history" style="display: none; margin-top: 2rem;" class="card">
      <div style="padding: 2rem;">
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1.5rem;">ğŸ“œ Historique de vos commandes</h3>
        <div id="history-list"></div>
      </div>
    </div>
  </section>

  <!-- Section BibliothÃ¨que -->
  <section id="bibliotheque" class="section">
    <h2 class="gold-text" style="text-align: center; font-size: 2.5rem; margin-bottom: 2rem;">ğŸ“š Ma BibliothÃ¨que</h2>
    
    <div id="bibliotheque-login-required" class="card" style="padding: 2rem; text-align: center;">
      <p style="color: #FFD700; font-size: 1.125rem; margin-bottom: 1rem;">Connectez-vous pour accÃ©der Ã  votre bibliothÃ¨que !</p>
      <button onclick="showSection('panier')" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 0.5rem;">
        Se connecter
      </button>
    </div>

    <div id="bibliotheque-content" style="display: none;">
      <div style="margin-bottom: 2rem; text-align: center;">
        <p style="color: #FFD700; font-size: 1.125rem;">Total d'objets: <strong id="total-objets" class="gold-text">0</strong></p>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ† GOAT</h3>
        <div id="goat-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ’ Rare</h3>
        <div id="rare-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
      </div>

      <div style="margin-bottom: 2rem;">
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">â­ Basique</h3>
        <div id="basique-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
      </div>

      <div>
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ“¦ Nul</h3>
        <div id="nul-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;"></div>
      </div>
    </div>
  </section>

  <!-- Section Classement -->
  <section id="classement" class="section">
    <h2 class="gold-text" style="text-align: center; font-size: 2.5rem; margin-bottom: 2rem;">ğŸ† Classement des Plus Riches</h2>
    
    <div class="card" style="padding: 2rem;">
      <div id="classement-podium" style="display: flex; flex-direction: column; gap: 1.5rem;"></div>
    </div>
  </section>

  <!-- Section Jeu -->
  <section id="jeu" class="section">
    <h2 class="gold-text" style="text-align: center; font-size: 2.5rem; margin-bottom: 2rem;">ğŸ® Geometry Dash</h2>
    
    <div id="jeu-login-required" class="card" style="padding: 2rem; text-align: center;">
      <p style="color: #FFD700; font-size: 1.125rem; margin-bottom: 1rem;">Connectez-vous pour jouer et gagner des cailloux !</p>
      <button onclick="showSection('panier')" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 0.5rem;">
        Se connecter
      </button>
    </div>

    <div id="jeu-content" style="display: none;">
      <div class="card" style="padding: 2rem; margin-bottom: 2rem; text-align: center;">
        <p style="color: #FFD700; font-size: 1.125rem; margin-bottom: 0.5rem;">Gagnez <strong class="gold-text">1 caillou</strong> toutes les 10 secondes tant que vous Ãªtes en vie !</p>
        <p style="color: #FFD700; font-size: 1rem;">Appuyez sur ESPACE ou cliquez pour sauter</p>
      </div>

      <div style="text-align: center; margin-bottom: 1rem;">
        <p style="color: #FFD700; font-size: 1.25rem;">Score: <strong id="game-score" class="gold-text">0</strong> | Cailloux gagnÃ©s: <strong id="game-earnings" class="gold-text">0</strong></p>
      </div>

      <canvas id="game-canvas" width="800" height="400"></canvas>

      <div style="text-align: center; margin-top: 1.5rem;">
        <button id="start-game-btn" onclick="startGame()" class="btn-primary" style="padding: 1rem 2rem; border-radius: 0.5rem; font-size: 1.125rem;">
          â–¶ï¸ DÃ©marrer le Jeu
        </button>
        <button id="restart-game-btn" onclick="restartGame()" style="display: none; padding: 1rem 2rem; border-radius: 0.5rem; font-size: 1.125rem; background: #8B0000; color: #FFD700; border: 2px solid #FFD700; font-weight: bold; cursor: pointer;">
          ğŸ”„ Rejouer
        </button>
      </div>
    </div>
  </section>

  <!-- Section Messages -->
  <section id="messages" class="section">
    <h2 class="gold-text" style="text-align: center; font-size: 2.5rem; margin-bottom: 2rem;">ğŸ’¬ Messages</h2>

    <div id="messages-login-required" class="card" style="padding: 2rem; text-align: center;">
      <p style="color: #FFD700; font-size: 1.125rem; margin-bottom: 1rem;">Connectez-vous pour accÃ©der Ã  la messagerie !</p>
      <button onclick="showSection('panier')" class="btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 0.5rem;">
        Se connecter
      </button>
    </div>

    <div id="messages-interface" style="display: none;">
      <div class="card" style="padding: 1rem;">
        <p style="color: #FFD700; text-align: center;">Messagerie disponible prochainement...</p>
      </div>
    </div>
  </section>

  <!-- Section Admin -->
  <section id="admin" class="section">
    <h1 class="gold-text" style="text-align: center; font-size: 2.5rem; margin-bottom: 2rem;">âš™ï¸ Panneau Administrateur</h1>

    <!-- Gestion des cailloux -->
    <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
      <h2 class="gold-text" style="font-size: 1.75rem; margin-bottom: 1.5rem;">ğŸ’° Gestion des Cailloux</h2>

      <form onsubmit="ajouterCailloux(event)" style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Utilisateur</label>
          <input type="text" name="username" placeholder="Nom d'utilisateur (ex: MAXIME)" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Montant (positif pour ajouter, nÃ©gatif pour retirer)</label>
          <input type="number" name="montant" placeholder="Ex: 1000 ou -500" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-size: 1.125rem;">
          ğŸ’¸ Modifier le solde
        </button>
      </form>
    </div>

    <!-- Gestion des produits -->
    <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
      <h2 class="gold-text" style="font-size: 1.75rem; margin-bottom: 1.5rem;">ğŸ“¦ Ajouter un Produit</h2>

      <form onsubmit="ajouterProduit(event)" style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Nom du produit</label>
          <input type="text" name="nom" placeholder="Ex: Super Stylo" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Prix (en cailloux)</label>
          <input type="number" name="prix" placeholder="Ex: 50" min="1" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Type</label>
          <select name="type" onchange="toggleImageUrl(this.value)" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <option value="emoji">Emoji</option>
            <option value="image">Image</option>
          </select>
        </div>

        <div id="emoji-input">
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Emoji</label>
          <input type="text" name="emoji" placeholder="Ex: ğŸ¨" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <div id="image-input" style="display: none;">
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">URL de l'image</label>
          <input type="url" name="imageUrl" placeholder="https://..." style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">RaretÃ©</label>
          <select name="raretÃ©" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
            <option value="nul">Nul</option>
            <option value="basique">Basique</option>
            <option value="rare">Rare</option>
            <option value="goat">GOAT</option>
          </select>
        </div>

        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">DurÃ©e de disponibilitÃ© (heures, 0 = permanent)</label>
          <input type="number" name="duree" placeholder="Ex: 24" min="0" value="0" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-size: 1.125rem;">
          â• Ajouter le produit
        </button>
      </form>
    </div>

    <!-- Gestion des utilisateurs -->
    <div class="card" style="padding: 2rem; margin-bottom: 2rem;" id="admin-ban-section">
      <h2 class="gold-text" style="font-size: 1.75rem; margin-bottom: 1.5rem;">ğŸš« Bannir un Utilisateur</h2>

      <form onsubmit="bannirUtilisateur(event)" style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Utilisateur Ã  bannir</label>
          <input type="text" name="username" placeholder="Nom d'utilisateur" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-size: 1.125rem; background: #8B0000;">
          ğŸš« Bannir
        </button>
      </form>

      <div style="margin-top: 1.5rem;">
        <h3 class="gold-text" style="font-size: 1.25rem; margin-bottom: 1rem;">Liste des bannis</h3>
        <div id="banned-list" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
      </div>
    </div>

    <!-- Gestion des salaires (HARMAN uniquement) -->
    <div class="card" style="padding: 2rem;" id="admin-salary-section">
      <h2 class="gold-text" style="font-size: 1.75rem; margin-bottom: 1.5rem;">ğŸ’¼ Gestion des Salaires</h2>

      <form onsubmit="ajouterSalarie(event)" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Utilisateur</label>
          <input type="text" name="username" placeholder="Nom d'utilisateur" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <div>
          <label style="display: block; color: #FFD700; font-weight: 600; margin-bottom: 0.5rem;">Salaire mensuel (cailloux)</label>
          <input type="number" name="salaire" placeholder="Ex: 1900" min="1" required style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #FFD700; background: rgba(0,0,0,0.3); color: #FFD700; font-size: 16px;">
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-size: 1.125rem;">
          â• Ajouter un salariÃ©
        </button>
      </form>

      <div>
        <h3 class="gold-text" style="font-size: 1.25rem; margin-bottom: 1rem;">Liste des salariÃ©s</h3>
        <p style="color: #FFD700; font-size: 0.875rem; margin-bottom: 1rem;">Les salaires sont versÃ©s automatiquement le 28 de chaque mois</p>
        <div id="salary-list" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
      </div>
    </div>
  </section>

</main>

<footer style="padding: 1.5rem; text-align: center;">
  <div style="max-width: 1280px; margin: 0 auto; padding: 0 1rem;">
    <p style="color: rgba(255, 215, 0, 0.6); font-size: 0.875rem; margin-bottom: 0.5rem;">
      ğŸ’» DÃ©veloppÃ© par <strong style="color: rgba(255, 215, 0, 0.9);">har22fra (Harman Singh)</strong>
    </p>
    <p style="color: rgba(255, 215, 0, 0.5); font-size: 0.75rem;">
      ğŸ“œ Ce site est sous licence <a href="https://opensource.org/licenses/MIT" target="_blank" style="color: #FFD700; text-decoration: underline;">MIT License</a> - Â© 2025
    </p>
  </div>
</footer>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBKHf8RQaKwPGPYZ6BNPKkGkF7v7YPkCbo",
  authDomain: "harman-shop.firebaseapp.com",
  projectId: "harman-shop",
  storageBucket: "harman-shop.firebasestorage.app",
  messagingSenderId: "990698016430",
  appId: "1:990698016430:web:3aa19cfa6dfedd8c72db2e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global Variables
let currentUser = null;
let panier = [];
let articles = [];
let utilisateurs = {};
let bannedUsers = [];
let salaries = {};

// Utilisateurs par dÃ©faut avec codes QR
const defaultUsers = {
  'HARMAN': { solde: 100000000000, motDePasse: '1234', qrCode: '220112', isAdmin: true, canManageSalaries: true },
  'ADMIN': { solde: 999999999999, motDePasse: 'Dasntesreve', qrCode: '000000', isAdmin: true, canManageSalaries: false },
  'CAMILLE': { solde: 10, motDePasse: 'fille', qrCode: '429203', isAdmin: true, canManageSalaries: false },
  'ALEXANDRE': { solde: 100000000, motDePasse: 'bonjour', qrCode: '123456' },
  'MAXIME': { solde: 10, motDePasse: 'football', qrCode: '654321' },
  'GABRIEL': { solde: 10, motDePasse: 'con', qrCode: '111111' }
};

// Codes promo
const codesPromo = {
  'OUI': 10,
  'UNCHAINED': 10,
  'CAMILLE': 20,
  'JOLIPASCHER2025': 30,
  'HARMANLEBG': 40,
  'FRANKLEBOEUF': 99
};

// Initialize
setTimeout(() => {
  document.getElementById('loading-screen').style.display = 'none';
}, 5000);

initFirebase();

async function initFirebase() {
  try {
    // Charger les utilisateurs
    const usersSnapshot = await db.collection('utilisateurs').get();
    usersSnapshot.forEach(doc => {
      utilisateurs[doc.id] = doc.data();
    });

    // Ajouter les utilisateurs par dÃ©faut s'ils n'existent pas
    for (const [username, data] of Object.entries(defaultUsers)) {
      if (!utilisateurs[username]) {
        await db.collection('utilisateurs').doc(username).set({
          solde: data.solde,
          motDePasse: data.motDePasse,
          email: '',
          emailVerifie: false,
          createdAt: new Date()
        });
        utilisateurs[username] = data;
      }
    }

    // Charger les articles
    const articlesSnapshot = await db.collection('articles').get();
    articlesSnapshot.forEach(doc => {
      articles.push({ id: doc.id, ...doc.data() });
    });

    // Charger les utilisateurs bannis
    const bannedSnapshot = await db.collection('banned').get();
    bannedSnapshot.forEach(doc => {
      bannedUsers.push(doc.id);
    });

    // Charger les salariÃ©s
    const salariesSnapshot = await db.collection('salaries').get();
    salariesSnapshot.forEach(doc => {
      salaries[doc.id] = doc.data();
    });

    // Initialiser les salariÃ©s par dÃ©faut
    if (!salaries['CAMILLE']) {
      await db.collection('salaries').doc('CAMILLE').set({
        salaire: 1900,
        dernierVersement: null
      });
      salaries['CAMILLE'] = { salaire: 1900, dernierVersement: null };
    }

    afficherArticles();
    verifierSalaires();
  } catch (error) {
    console.error('Erreur Firebase:', error);
  }
}

// VÃ©rifier et verser les salaires
async function verifierSalaires() {
  const now = new Date();
  const jour = now.getDate();
  
  if (jour === 28) {
    for (const [username, data] of Object.entries(salaries)) {
      const dernierVersement = data.dernierVersement ? new Date(data.dernierVersement) : null;
      
      // VÃ©rifier si le salaire n'a pas dÃ©jÃ  Ã©tÃ© versÃ© ce mois-ci
      if (!dernierVersement || dernierVersement.getMonth() !== now.getMonth()) {
        try {
          const userDoc = await db.collection('utilisateurs').doc(username).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            await db.collection('utilisateurs').doc(username).update({
              solde: userData.solde + data.salaire
            });
            
            await db.collection('salaries').doc(username).update({
              dernierVersement: now.toISOString()
            });
            
            showToast(`Salaire de ${data.salaire} cailloux versÃ© Ã  ${username}!`, 'success');
          }
        } catch (error) {
          console.error('Erreur versement salaire:', error);
        }
      }
    }
  }
}

// UI Functions
function toggleMenu() {
  const menu = document.getElementById('menu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(sectionId).classList.add('active');
  document.getElementById('menu').style.display = 'none';

  if (sectionId === 'bibliotheque') {
    afficherBibliotheque();
  } else if (sectionId === 'classement') {
    afficherClassement();
  } else if (sectionId === 'jeu') {
    afficherJeu();
  } else if (sectionId === 'messages') {
    afficherMessages();
  } else if (sectionId === 'admin') {
    afficherAdmin();
  }
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    background: ${type === 'success' ? '#51cf66' : type === 'error' ? '#ff6b6b' : '#FFD700'};
    color: ${type === 'success' || type === 'error' ? 'white' : '#2c2420'};
    border-radius: 10px;
    font-weight: bold;
    z-index: 10001;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function showCustomModal(title, message, onConfirm) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 1rem;">${title}</h3>
      <p style="color: #FFD700; margin-bottom: 1.5rem;">${message}</p>
      <div style="display: flex; gap: 1rem;">
        <button onclick="this.closest('.modal-overlay').remove()" class="btn-primary" style="flex: 1; padding: 0.5rem; border-radius: 0.5rem;">Annuler</button>
        <button onclick="this.closest('.modal-overlay').remove(); (${onConfirm})()" class="btn-primary" style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; background: #8B0000;">Confirmer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Auth Functions
function toggleClassicLogin() {
  const form = document.getElementById('classic-login-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  document.getElementById('signup-form').style.display = 'none';
}

function toggleSignup() {
  const form = document.getElementById('signup-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  document.getElementById('classic-login-form').style.display = 'none';
}

async function handleClassicLogin(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const identifiant = formData.get('identifiant').toUpperCase();
  const motDePasse = formData.get('motDePasse');

  // VÃ©rifier si l'utilisateur est banni
  if (bannedUsers.includes(identifiant)) {
    document.getElementById('login-error').textContent = 'Vous Ãªtes banni de cette plateforme.';
    return;
  }

  try {
    const userDoc = await db.collection('utilisateurs').doc(identifiant).get();
    if (userDoc.exists && userDoc.data().motDePasse === motDePasse) {
      currentUser = identifiant;
      afficherUserDashboard();
      showToast('Connexion rÃ©ussie!', 'success');
    } else {
      document.getElementById('login-error').textContent = 'Identifiant ou mot de passe incorrect';
    }
  } catch (error) {
    console.error('Erreur connexion:', error);
    document.getElementById('login-error').textContent = 'Erreur de connexion';
  }
}

async function handleSignup(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const identifiant = formData.get('identifiant').toUpperCase();
  const email = formData.get('email');
  const motDePasse = formData.get('motDePasse');
  const confirmMotDePasse = formData.get('confirmMotDePasse');

  if (motDePasse !== confirmMotDePasse) {
    document.getElementById('signup-error').textContent = 'Les mots de passe ne correspondent pas';
    return;
  }

  try {
    const userDoc = await db.collection('utilisateurs').doc(identifiant).get();
    if (userDoc.exists) {
      document.getElementById('signup-error').textContent = 'Cet identifiant existe dÃ©jÃ ';
      return;
    }

    await db.collection('utilisateurs').doc(identifiant).set({
      solde: 10,
      motDePasse: motDePasse,
      email: email,
      emailVerifie: false,
      createdAt: new Date()
    });

    document.getElementById('signup-success').textContent = 'Compte crÃ©Ã© avec succÃ¨s! Vous pouvez vous connecter.';
    setTimeout(() => {
      document.getElementById('signup-form').style.display = 'none';
      toggleClassicLogin();
    }, 2000);
  } catch (error) {
    console.error('Erreur crÃ©ation compte:', error);
    document.getElementById('signup-error').textContent = 'Erreur lors de la crÃ©ation du compte';
  }
}

async function afficherUserDashboard() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('user-dashboard').style.display = 'block';
  document.getElementById('order-history').style.display = 'block';
  document.getElementById('messages-menu-btn').style.display = 'block';

  const userDoc = await db.collection('utilisateurs').doc(currentUser).get();
  const userData = userDoc.data();

  document.getElementById('user-name').textContent = currentUser;
  document.getElementById('user-balance').textContent = userData.solde.toLocaleString();

  // VÃ©rifier si l'utilisateur est admin
  if (defaultUsers[currentUser]?.isAdmin) {
    document.getElementById('admin-menu-btn').style.display = 'block';
  }

  afficherHistoriqueCommandes();
}

function logout() {
  currentUser = null;
  panier = [];
  document.getElementById('login-section').style.display = 'block';
  document.getElementById('user-dashboard').style.display = 'none';
  document.getElementById('order-history').style.display = 'none';
  document.getElementById('messages-menu-btn').style.display = 'none';
  document.getElementById('admin-menu-btn').style.display = 'none';
  afficherPanier();
  showToast('DÃ©connexion rÃ©ussie', 'success');
}

// QR Code Scanner
let qrStream = null;
let qrUsername = null;

async function startQRScanner() {
  document.getElementById('qr-scanner-overlay').style.display = 'flex';
  const video = document.getElementById('qr-video');
  const canvas = document.getElementById('qr-canvas');
  const context = canvas.getContext('2d');

  try {
    qrStream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' } 
    });
    video.srcObject = qrStream;
    document.getElementById('scan-message').textContent = 'Placez le QR code dans le cadre';

    const scanQR = () => {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          qrUsername = code.data;
          stopQRScanner();
          document.getElementById('qr-code-verification-overlay').style.display = 'flex';
          document.getElementById('qr-user-prompt').textContent = `Code dÃ©tectÃ© pour ${qrUsername}. Entrez votre code secret.`;
        }
      }
      if (qrStream) {
        requestAnimationFrame(scanQR);
      }
    };
    scanQR();
  } catch (error) {
    console.error('Erreur camÃ©ra:', error);
    document.getElementById('scan-message').textContent = 'Impossible d\'accÃ©der Ã  la camÃ©ra';
  }
}

function stopQRScanner() {
  if (qrStream) {
    qrStream.getTracks().forEach(track => track.stop());
    qrStream = null;
  }
  document.getElementById('qr-scanner-overlay').style.display = 'none';
}

async function handleQRVerify(event) {
  event.preventDefault();
  const secretCode = document.getElementById('qr-secret-code').value;

  const userDefault = defaultUsers[qrUsername];
  if (userDefault && userDefault.qrCode === secretCode) {
    currentUser = qrUsername;
    document.getElementById('qr-code-verification-overlay').style.display = 'none';
    afficherUserDashboard();
    showToast('Connexion QR rÃ©ussie!', 'success');
  } else {
    document.getElementById('qr-verify-error').textContent = 'Code secret incorrect';
  }
}

function cancelQRVerify() {
  document.getElementById('qr-code-verification-overlay').style.display = 'none';
  qrUsername = null;
}

// Shop Functions
function afficherArticles() {
  const container = document.getElementById('articles-container');
  container.innerHTML = '';

  // Nettoyer les articles expirÃ©s
  const now = new Date();
  articles = articles.filter(article => {
    if (article.expireAt && new Date(article.expireAt) < now) {
      db.collection('articles').doc(article.id).delete();
      return false;
    }
    return true;
  });

  articles.forEach(article => {
    const card = document.createElement('div');
    card.className = `card rarity-${article.raretÃ© || 'basique'}`;
    card.style.cssText = 'padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.3s;';
    card.onmouseover = () => card.style.transform = 'scale(1.05)';
    card.onmouseout = () => card.style.transform = 'scale(1)';

    const rarityBadge = article.raretÃ© ? `<div style="background: ${
      article.raretÃ© === 'goat' ? '#FFD700' :
      article.raretÃ© === 'rare' ? '#9945ff' :
      article.raretÃ© === 'basique' ? '#4a9eff' : '#666'
    }; color: white; padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.75rem; font-weight: bold; margin-bottom: 0.5rem; display: inline-block;">${article.raretÃ©.toUpperCase()}</div>` : '';

    const expireBadge = article.expireAt ? `<div style="background: #ff6b6b; color: white; padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.75rem; margin-bottom: 0.5rem;">â° LIMITÃ‰</div>` : '';

    card.innerHTML = `
      ${rarityBadge}
      ${expireBadge}
      ${article.img ? `<img src="${article.img}" alt="${article.nom}" style="width: 100px; height: 100px; object-fit: contain; margin: 0 auto 1rem;">` : `<div style="font-size: 4rem; margin-bottom: 1rem;">${article.emoji || 'ğŸ“¦'}</div>`}
      <h3 class="gold-text" style="font-size: 1.25rem; margin-bottom: 0.5rem;">${article.nom}</h3>
      <p class="gold-text" style="font-size: 1.125rem; margin-bottom: 1rem;">${article.prix} cailloux</p>
      <button onclick="ajouterAuPanier('${article.id}')" class="btn-primary" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem;">Ajouter au panier</button>
    `;

    container.appendChild(card);
  });
}

function filtrerArticles() {
  const recherche = document.getElementById('recherche').value.toLowerCase();
  const container = document.getElementById('articles-container');
  const cards = container.children;

  for (let card of cards) {
    const nom = card.querySelector('h3').textContent.toLowerCase();
    card.style.display = nom.includes(recherche) ? 'block' : 'none';
  }
}

function ajouterAuPanier(articleId) {
  const article = articles.find(a => a.id === articleId);
  if (!article) return;

  const existant = panier.find(item => item.id === articleId);
  if (existant) {
    existant.quantite++;
  } else {
    panier.push({ ...article, quantite: 1 });
  }

  afficherPanier();
  showToast('Article ajoutÃ© au panier!', 'success');
}

function afficherPanier() {
  const emptyCart = document.getElementById('empty-cart');
  const listePanier = document.getElementById('liste-panier');
  const totalPanier = document.getElementById('total-panier');
  const buyButton = document.getElementById('buy-button');
  const clearButton = document.getElementById('clear-cart-button');

  if (panier.length === 0) {
    emptyCart.style.display = 'block';
    listePanier.style.display = 'none';
    totalPanier.style.display = 'none';
    buyButton.style.display = 'none';
    clearButton.style.display = 'none';
    return;
  }

  emptyCart.style.display = 'none';
  listePanier.style.display = 'block';
  totalPanier.style.display = 'block';
  buyButton.style.display = 'block';
  clearButton.style.display = 'block';

  listePanier.innerHTML = '';
  let total = 0;

  panier.forEach((item, index) => {
    const li = document.createElement('li');
    li.style.cssText = 'background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 10px; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;';
    
    const itemTotal = item.prix * item.quantite;
    total += itemTotal;

    li.innerHTML = `
      <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
        ${item.img ? `<img src="${item.img}" alt="${item.nom}" style="width: 50px; height: 50px; object-fit: contain;">` : `<span style="font-size: 2rem;">${item.emoji || 'ğŸ“¦'}</span>`}
        <div>
          <div class="gold-text" style="font-weight: bold;">${item.nom}</div>
          <div style="color: #FFD700; font-size: 0.875rem;">${item.prix} cailloux Ã— ${item.quantite} = ${itemTotal} cailloux</div>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button onclick="modifierQuantite(${index}, -1)" style="background: #8B0000; color: #FFD700; border: 1px solid #FFD700; padding: 0.25rem 0.5rem; border-radius: 5px; cursor: pointer;">âˆ’</button>
        <span class="gold-text" style="font-weight: bold;">${item.quantite}</span>
        <button onclick="modifierQuantite(${index}, 1)" style="background: #8B7355; color: #FFD700; border: 1px solid #FFD700; padding: 0.25rem 0.5rem; border-radius: 5px; cursor: pointer;">+</button>
        <button onclick="retirerDuPanier(${index})" style="background: #8B0000; color: #FFD700; border: 1px solid #FFD700; padding: 0.25rem 0.5rem; border-radius: 5px; cursor: pointer;">ğŸ—‘ï¸</button>
      </div>
    `;

    listePanier.appendChild(li);
  });

  totalPanier.textContent = `Total : ${total} cailloux`;
}

function modifierQuantite(index, delta) {
  panier[index].quantite += delta;
  if (panier[index].quantite <= 0) {
    panier.splice(index, 1);
  }
  afficherPanier();
}

function retirerDuPanier(index) {
  panier.splice(index, 1);
  afficherPanier();
}

function viderPanier() {
  panier = [];
  afficherPanier();
  showToast('Panier vidÃ©', 'info');
}

async function acheter() {
  if (!currentUser) {
    showToast('Veuillez vous connecter', 'error');
    return;
  }

  if (panier.length === 0) {
    showToast('Votre panier est vide', 'error');
    return;
  }

  const total = panier.reduce((sum, item) => sum + (item.prix * item.quantite), 0);
  
  try {
    const userDoc = await db.collection('utilisateurs').doc(currentUser).get();
    const userData = userDoc.data();

    if (userData.solde < total) {
      showToast('Solde insuffisant', 'error');
      return;
    }

    // DÃ©duire le montant
    await db.collection('utilisateurs').doc(currentUser).update({
      solde: userData.solde - total
    });

    // Ajouter les articles Ã  la bibliothÃ¨que
    for (const item of panier) {
      for (let i = 0; i < item.quantite; i++) {
        await db.collection('bibliotheque').add({
          utilisateur: currentUser,
          article: item.nom,
          raretÃ©: item.raretÃ© || 'basique',
          emoji: item.emoji || 'ğŸ“¦',
          img: item.img || null,
          dateAchat: new Date()
        });
      }
    }

    // Enregistrer la commande
    await db.collection('commandes').add({
      utilisateur: currentUser,
      articles: panier,
      total: total,
      date: new Date(),
      numero: 'JPC-' + Math.random().toString(36).substr(2, 10).toUpperCase()
    });

    showToast('Achat rÃ©ussi! Consultez votre bibliothÃ¨que.', 'success');
    panier = [];
    afficherPanier();
    afficherUserDashboard();
  } catch (error) {
    console.error('Erreur achat:', error);
    showToast('Erreur lors de l\'achat', 'error');
  }
}

async function envoyerCailloux(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const destinataire = formData.get('destinataire').toUpperCase();
  const montant = parseInt(formData.get('montant'));

  if (!currentUser) {
    showToast('Vous devez Ãªtre connectÃ©', 'error');
    return;
  }

  try {
    const userDoc = await db.collection('utilisateurs').doc(currentUser).get();
    const destDoc = await db.collection('utilisateurs').doc(destinataire).get();

    if (!destDoc.exists) {
      showToast('Utilisateur destinataire introuvable', 'error');
      return;
    }

    const userData = userDoc.data();
    if (userData.solde < montant) {
      showToast('Solde insuffisant', 'error');
      return;
    }

    await db.collection('utilisateurs').doc(currentUser).update({
      solde: userData.solde - montant
    });

    const destData = destDoc.data();
    await db.collection('utilisateurs').doc(destinataire).update({
      solde: destData.solde + montant
    });

    showToast(`${montant} cailloux envoyÃ©s Ã  ${destinataire}!`, 'success');
    afficherUserDashboard();
    event.target.reset();
  } catch (error) {
    console.error('Erreur envoi:', error);
    showToast('Erreur lors de l\'envoi', 'error');
  }
}

function handleCodeInput(event) {
  if (event.key === 'Enter') {
    const code = event.target.value.toUpperCase();
    const reduction = codesPromo[code];
    
    if (reduction) {
      document.getElementById('code-success').style.display = 'block';
      document.getElementById('code-success').textContent = `Code validÃ©! ${reduction}% de rÃ©duction`;
      event.target.value = '';
    }
  }
}

async function afficherHistoriqueCommandes() {
  const historyList = document.getElementById('history-list');
  historyList.innerHTML = '';

  try {
    const commandesSnapshot = await db.collection('commandes')
      .where('utilisateur', '==', currentUser)
      .orderBy('date', 'desc')
      .get();

    commandesSnapshot.forEach(doc => {
      const commande = doc.data();
      const div = document.createElement('div');
      div.style.cssText = 'background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;';
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span class="gold-text" style="font-weight: bold;">Commande ${commande.numero}</span>
          <span style="color: #FFD700;">${new Date(commande.date.toDate()).toLocaleDateString()}</span>
        </div>
        <div style="color: #FFD700; margin-bottom: 0.5rem;">
          Articles: ${commande.articles.map(a => `${a.nom} (x${a.quantite})`).join(', ')}
        </div>
        <div class="gold-text" style="font-weight: bold;">Total: ${commande.total} cailloux</div>
      `;

      historyList.appendChild(div);
    });
  } catch (error) {
    console.error('Erreur historique:', error);
  }
}

// Packs
function getRarityFromRandom() {
  const rand = Math.random() * 100;
  if (rand < 1) return 'goat';
  if (rand < 20) return 'rare';
  if (rand < 50) return 'basique';
  return 'nul';
}

async function ouvrirPack(typePack) {
  if (!currentUser) {
    showToast('Connectez-vous pour ouvrir des packs!', 'error');
    return;
  }

  const prix = {
    'basique': 100,
    'rare': 500,
    'goat': 2000
  };

  const prixPack = prix[typePack];

  try {
    const userDoc = await db.collection('utilisateurs').doc(currentUser).get();
    const userData = userDoc.data();

    if (userData.solde < prixPack) {
      showToast('Solde insuffisant', 'error');
      return;
    }

    // DÃ©duire le prix
    await db.collection('utilisateurs').doc(currentUser).update({
      solde: userData.solde - prixPack
    });

    // GÃ©nÃ©rer un objet alÃ©atoire
    const raretÃ© = getRarityFromRandom();
    const emojis = ['ğŸ¨', 'âš½', 'ğŸ¸', 'ğŸ®', 'ğŸ“±', 'ğŸ’', 'ğŸ‘‘', 'ğŸ”¥', 'â­', 'ğŸ†'];
    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
    const nomObjet = `Objet ${raretÃ©} ${randomEmoji}`;

    // Ajouter Ã  la bibliothÃ¨que
    await db.collection('bibliotheque').add({
      utilisateur: currentUser,
      article: nomObjet,
      raretÃ©: raretÃ©,
      emoji: randomEmoji,
      img: null,
      dateAchat: new Date()
    });

    showToast(`Pack ouvert! Vous avez obtenu: ${nomObjet} (${raretÃ©.toUpperCase()})`, 'success');
    afficherUserDashboard();
  } catch (error) {
    console.error('Erreur ouverture pack:', error);
    showToast('Erreur lors de l\'ouverture du pack', 'error');
  }
}

// BibliothÃ¨que
async function afficherBibliotheque() {
  const loginRequired = document.getElementById('bibliotheque-login-required');
  const content = document.getElementById('bibliotheque-content');

  if (!currentUser) {
    loginRequired.style.display = 'block';
    content.style.display = 'none';
    return;
  }

  loginRequired.style.display = 'none';
  content.style.display = 'block';

  try {
    const bibliothequeSnapshot = await db.collection('bibliotheque')
      .where('utilisateur', '==', currentUser)
      .get();

    const items = { goat: [], rare: [], basique: [], nul: [] };
    let total = 0;

    bibliothequeSnapshot.forEach(doc => {
      const item = doc.data();
      items[item.raretÃ© || 'basique'].push(item);
      total++;
    });

    document.getElementById('total-objets').textContent = total;

    // Afficher par raretÃ©
    ['goat', 'rare', 'basique', 'nul'].forEach(raretÃ© => {
      const container = document.getElementById(`${raretÃ©}-items`);
      container.innerHTML = '';

      if (items[raretÃ©].length === 0) {
        container.innerHTML = '<p style="color: rgba(255, 215, 0, 0.5); font-style: italic;">Aucun objet</p>';
      } else {
        items[raretÃ©].forEach(item => {
          const card = document.createElement('div');
          card.className = `card rarity-${raretÃ©}`;
          card.style.cssText = 'padding: 1rem; text-align: center;';

          card.innerHTML = `
            ${item.img ? `<img src="${item.img}" alt="${item.article}" style="width: 80px; height: 80px; object-fit: contain; margin: 0 auto 0.5rem;">` : `<div style="font-size: 3rem; margin-bottom: 0.5rem;">${item.emoji || 'ğŸ“¦'}</div>`}
            <h4 class="gold-text" style="font-size: 1rem;">${item.article}</h4>
            <p style="color: #FFD700; font-size: 0.75rem;">${new Date(item.dateAchat.toDate()).toLocaleDateString()}</p>
          `;

          container.appendChild(card);
        });
      }
    });
  } catch (error) {
    console.error('Erreur bibliothÃ¨que:', error);
  }
}

// Classement
async function afficherClassement() {
  const podium = document.getElementById('classement-podium');
  podium.innerHTML = '';

  try {
    const usersSnapshot = await db.collection('utilisateurs').get();
    const users = [];

    usersSnapshot.forEach(doc => {
      users.push({ username: doc.id, solde: doc.data().solde });
    });

    users.sort((a, b) => b.solde - a.solde);
    const top3 = users.slice(0, 3);

    top3.forEach((user, index) => {
      const position = index + 1;
      const medal = position === 1 ? 'ğŸ¥‡' : position === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
      const bgColor = position === 1 ? 'rgba(255, 215, 0, 0.2)' : position === 2 ? 'rgba(192, 192, 192, 0.2)' : 'rgba(205, 127, 50, 0.2)';

      const card = document.createElement('div');
      card.style.cssText = `background: ${bgColor}; border: 2px solid #FFD700; border-radius: 15px; padding: 1.5rem; text-align: center;`;

      card.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 0.5rem;">${medal}</div>
        <h3 class="gold-text" style="font-size: 1.5rem; margin-bottom: 0.5rem;">${user.username}</h3>
        <p style="color: #FFD700; font-size: 1.25rem; font-weight: bold;">${user.solde.toLocaleString()} cailloux</p>
      `;

      podium.appendChild(card);
    });
  } catch (error) {
    console.error('Erreur classement:', error);
  }
}

// Jeu Geometry Dash
let gameCanvas, gameCtx;
let gameRunning = false;
let gameScore = 0;
let gameEarnings = 0;
let lastEarningTime = 0;
let player = { x: 100, y: 250, width: 40, height: 40, velocityY: 0, jumping: false };
let obstacles = [];
let gameSpeed = 5;

function afficherJeu() {
  const loginRequired = document.getElementById('jeu-login-required');
  const content = document.getElementById('jeu-content');

  if (!currentUser) {
    loginRequired.style.display = 'block';
    content.style.display = 'none';
    return;
  }

  loginRequired.style.display = 'none';
  content.style.display = 'block';

  gameCanvas = document.getElementById('game-canvas');
  gameCtx = gameCanvas.getContext('2d');
}

function startGame() {
  if (gameRunning) return;

  gameRunning = true;
  gameScore = 0;
  gameEarnings = 0;
  lastEarningTime = Date.now();
  player = { x: 100, y: 250, width: 40, height: 40, velocityY: 0, jumping: false };
  obstacles = [];
  gameSpeed = 5;

  document.getElementById('start-game-btn').style.display = 'none';
  document.getElementById('restart-game-btn').style.display = 'none';

  document.addEventListener('keydown', handleJump);
  gameCanvas.addEventListener('click', handleJump);

  gameLoop();
}

function handleJump(e) {
  if (e.type === 'keydown' && e.code !== 'Space') return;
  if (!player.jumping && gameRunning) {
    player.velocityY = -12;
    player.jumping = true;
  }
}

function gameLoop() {
  if (!gameRunning) return;

  // Clear canvas
  gameCtx.fillStyle = '#2D2D2D';
  gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

  // Draw ground
  gameCtx.fillStyle = '#FFD700';
  gameCtx.fillRect(0, 350, gameCanvas.width, 50);

  // Update player
  player.velocityY += 0.6; // Gravity
  player.y += player.velocityY;

  if (player.y >= 310) {
    player.y = 310;
    player.velocityY = 0;
    player.jumping = false;
  }

  // Draw player (rock/caillou)
  gameCtx.fillStyle = '#8B7355';
  gameCtx.beginPath();
  gameCtx.arc(player.x + player.width / 2, player.y + player.height / 2, player.width / 2, 0, Math.PI * 2);
  gameCtx.fill();
  gameCtx.strokeStyle = '#FFD700';
  gameCtx.lineWidth = 2;
  gameCtx.stroke();

  // Generate obstacles
  if (Math.random() < 0.02) {
    obstacles.push({
      x: gameCanvas.width,
      y: 310,
      width: 30,
      height: 40
    });
  }

  // Update and draw obstacles
  for (let i = obstacles.length - 1; i >= 0; i--) {
    obstacles[i].x -= gameSpeed;

    gameCtx.fillStyle = '#8B0000';
    gameCtx.fillRect(obstacles[i].x, obstacles[i].y, obstacles[i].width, obstacles[i].height);

    // Collision detection
    if (
      player.x < obstacles[i].x + obstacles[i].width &&
      player.x + player.width > obstacles[i].x &&
      player.y < obstacles[i].y + obstacles[i].height &&
      player.y + player.height > obstacles[i].y
    ) {
      endGame();
      return;
    }

    // Remove off-screen obstacles
    if (obstacles[i].x + obstacles[i].width < 0) {
      obstacles.splice(i, 1);
      gameScore++;
    }
  }

  // Update earnings (1 caillou every 10 seconds)
  const now = Date.now();
  if (now - lastEarningTime >= 10000) {
    gameEarnings++;
    lastEarningTime = now;
  }

  // Update UI
  document.getElementById('game-score').textContent = gameScore;
  document.getElementById('game-earnings').textContent = gameEarnings;

  requestAnimationFrame(gameLoop);
}

async function endGame() {
  gameRunning = false;
  document.getElementById('restart-game-btn').style.display = 'block';

  // Ajouter les cailloux gagnÃ©s au solde
  if (gameEarnings > 0) {
    try {
      const userDoc = await db.collection('utilisateurs').doc(currentUser).get();
      const userData = userDoc.data();
      await db.collection('utilisateurs').doc(currentUser).update({
        solde: userData.solde + gameEarnings
      });
      showToast(`Vous avez gagnÃ© ${gameEarnings} cailloux!`, 'success');
      afficherUserDashboard();
    } catch (error) {
      console.error('Erreur mise Ã  jour solde:', error);
    }
  }
}

function restartGame() {
  startGame();
}

// Messages
function afficherMessages() {
  const loginRequired = document.getElementById('messages-login-required');
  const content = document.getElementById('messages-interface');

  if (!currentUser) {
    loginRequired.style.display = 'block';
    content.style.display = 'none';
    return;
  }

  loginRequired.style.display = 'none';
  content.style.display = 'block';
}

// Admin Functions
function afficherAdmin() {
  // Masquer la section salaires si pas HARMAN
  if (currentUser !== 'HARMAN') {
    document.getElementById('admin-salary-section').style.display = 'none';
  } else {
    document.getElementById('admin-salary-section').style.display = 'block';
    afficherListeSalaries();
  }
  
  afficherListeBannis();
}

function toggleImageUrl(type) {
  const emojiInput = document.getElementById('emoji-input');
  const imageInput = document.getElementById('image-input');
  
  if (type === 'image') {
    emojiInput.style.display = 'none';
    imageInput.style.display = 'block';
  } else {
    emojiInput.style.display = 'block';
    imageInput.style.display = 'none';
  }
}

async function ajouterCailloux(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const username = formData.get('username').toUpperCase();
  const montant = parseInt(formData.get('montant'));

  try {
    const userDoc = await db.collection('utilisateurs').doc(username).get();
    if (!userDoc.exists) {
      showToast('Utilisateur introuvable', 'error');
      return;
    }

    const userData = userDoc.data();
    await db.collection('utilisateurs').doc(username).update({
      solde: userData.solde + montant
    });

    showToast(`${montant} cailloux ${montant > 0 ? 'ajoutÃ©s Ã ' : 'retirÃ©s de'} ${username}!`, 'success');
    event.target.reset();
  } catch (error) {
    console.error('Erreur ajout cailloux:', error);
    showToast('Erreur lors de la modification', 'error');
  }
}

async function ajouterProduit(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const nom = formData.get('nom');
  const prix = parseInt(formData.get('prix'));
  const type = formData.get('type');
  const raretÃ© = formData.get('raretÃ©');
  const duree = parseInt(formData.get('duree'));

  const produit = {
    nom: nom,
    prix: prix,
    raretÃ©: raretÃ©,
    createdAt: new Date()
  };

  if (type === 'emoji') {
    produit.emoji = formData.get('emoji');
  } else {
    produit.img = formData.get('imageUrl');
  }

  if (duree > 0) {
    const expireDate = new Date();
    expireDate.setHours(expireDate.getHours() + duree);
    produit.expireAt = expireDate;
  }

  try {
    const docRef = await db.collection('articles').add(produit);
    articles.push({ id: docRef.id, ...produit });
    afficherArticles();
    showToast('Produit ajoutÃ© avec succÃ¨s!', 'success');
    event.target.reset();
  } catch (error) {
    console.error('Erreur ajout produit:', error);
    showToast('Erreur lors de l\'ajout du produit', 'error');
  }
}

async function bannirUtilisateur(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const username = formData.get('username').toUpperCase();

  // VÃ©rifier que l'utilisateur ne peut pas se bannir lui-mÃªme
  if (username === currentUser) {
    showToast('Vous ne pouvez pas vous bannir vous-mÃªme!', 'error');
    return;
  }

  // VÃ©rifier que CAMILLE ne peut pas bannir HARMAN
  if (currentUser === 'CAMILLE' && username === 'HARMAN') {
    showToast('Vous ne pouvez pas bannir HARMAN!', 'error');
    return;
  }

  try {
    await db.collection('banned').doc(username).set({
      bannedBy: currentUser,
      date: new Date()
    });
    bannedUsers.push(username);
    afficherListeBannis();
    showToast(`${username} a Ã©tÃ© banni`, 'success');
    event.target.reset();
  } catch (error) {
    console.error('Erreur ban:', error);
    showToast('Erreur lors du bannissement', 'error');
  }
}

async function debannirUtilisateur(username) {
  try {
    await db.collection('banned').doc(username).delete();
    bannedUsers = bannedUsers.filter(u => u !== username);
    afficherListeBannis();
    showToast(`${username} a Ã©tÃ© dÃ©banni`, 'success');
  } catch (error) {
    console.error('Erreur deban:', error);
    showToast('Erreur lors du dÃ©bannissement', 'error');
  }
}

function afficherListeBannis() {
  const listContainer = document.getElementById('banned-list');
  listContainer.innerHTML = '';

  if (bannedUsers.length === 0) {
    listContainer.innerHTML = '<p style="color: rgba(255, 215, 0, 0.5); font-style: italic;">Aucun utilisateur banni</p>';
    return;
  }

  bannedUsers.forEach(username => {
    const div = document.createElement('div');
    div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 5px;';
    div.innerHTML = `
      <span style="color: #FFD700;">${username}</span>
      <button onclick="debannirUtilisateur('${username}')" class="btn-primary" style="padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.875rem;">
        DÃ©bannir
      </button>
    `;
    listContainer.appendChild(div);
  });
}

async function ajouterSalarie(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const username = formData.get('username').toUpperCase();
  const salaire = parseInt(formData.get('salaire'));

  try {
    await db.collection('salaries').doc(username).set({
      salaire: salaire,
      dernierVersement: null
    });
    salaries[username] = { salaire: salaire, dernierVersement: null };
    afficherListeSalaries();
    showToast(`${username} ajoutÃ© avec un salaire de ${salaire} cailloux/mois`, 'success');
    event.target.reset();
  } catch (error) {
    console.error('Erreur ajout salariÃ©:', error);
    showToast('Erreur lors de l\'ajout du salariÃ©', 'error');
  }
}

async function supprimerSalarie(username) {
  try {
    await db.collection('salaries').doc(username).delete();
    delete salaries[username];
    afficherListeSalaries();
    showToast(`${username} retirÃ© des salariÃ©s`, 'success');
  } catch (error) {
    console.error('Erreur suppression salariÃ©:', error);
    showToast('Erreur lors de la suppression', 'error');
  }
}

function afficherListeSalaries() {
  const listContainer = document.getElementById('salary-list');
  listContainer.innerHTML = '';

  if (Object.keys(salaries).length === 0) {
    listContainer.innerHTML = '<p style="color: rgba(255, 215, 0, 0.5); font-style: italic;">Aucun salariÃ©</p>';
    return;
  }

  Object.entries(salaries).forEach(([username, data]) => {
    const div = document.createElement('div');
    div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 5px;';
    div.innerHTML = `
      <div style="color: #FFD700;">
        <strong>${username}</strong> - ${data.salaire} cailloux/mois
        ${data.dernierVersement ? `<br><small style="opacity: 0.7;">Dernier versement: ${new Date(data.dernierVersement).toLocaleDateString()}</small>` : ''}
      </div>
      <button onclick="supprimerSalarie('${username}')" class="btn-primary" style="padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.875rem; background: #8B0000;">
        Retirer
      </button>
    `;
    listContainer.appendChild(div);
  });
}

</script>

</body>
</html>