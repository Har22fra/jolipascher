<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü™® Jolie Pas Cher - Collectionnez des Cailloux !</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #d4af37;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --success: #27ae60;
            --light: #f8f9fa;
            --dark: #1a1a1a;
            --text: #333;
            --text-light: #666;
            --nul: #95a5a6;
            --basique: #3498db;
            --rare: #9b59b6;
            --goat: #f39c12;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--light);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }

        body.dark {
            --light: #1a1a1a;
            --dark: #f8f9fa;
            --text: #e0e0e0;
            --text-light: #a0a0a0;
            --secondary: #4a5f7f;
            background: var(--dark);
            color: var(--text);
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-screen.hide {
            display: none;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        body.dark .login-box {
            background: #2a2a2a;
        }

        .login-logo {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 2rem;
            font-weight: 900;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
        }

        body.dark .login-input {
            background: #3a3a3a;
            border-color: #4a4a4a;
            color: white;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #c9a532;
            transform: translateY(-2px);
        }

        .error-msg {
            color: var(--accent);
            margin-top: 1rem;
            font-size: 14px;
        }

        /* Navigation */
        nav {
            background: #2c3e50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        body.dark nav {
            background: #1e293b;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 900;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-links a {
            text-decoration: none;
            color: white;
            font-weight: 600;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            font-weight: 600;
        }

        .cailloux-count {
            background: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Hero Section */
        .hero {
            background: #2c3e50;
            color: white;
            padding: 4rem 2rem;
            text-align: center;
        }

        body.dark .hero {
            background: #1e293b;
        }

        .hero h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        body.dark .product-card {
            background: #2a2a2a;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .product-card.nul {
            border: 3px solid var(--nul);
        }

        .product-card.basique {
            border: 3px solid var(--basique);
        }

        .product-card.rare {
            border: 3px solid var(--rare);
        }

        .product-card.goat {
            border: 3px solid var(--goat);
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        .rarity-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 10;
        }

        .rarity-badge.nul {
            background: var(--nul);
        }

        .rarity-badge.basique {
            background: var(--basique);
        }

        .rarity-badge.rare {
            background: var(--rare);
        }

        .rarity-badge.goat {
            background: var(--goat);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .product-image {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            background: #f5f5f5;
        }

        body.dark .product-image {
            background: #3a3a3a;
        }

        .product-card.goat .product-image {
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .product-info {
            padding: 1.5rem;
        }

        .product-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .product-price {
            color: var(--primary);
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .product-expires {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 16px;
        }

        .btn:hover {
            background: #c9a532;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            margin-top: 0.5rem;
        }

        .btn-secondary:hover {
            background: #34495e;
        }

        .btn-danger {
            background: var(--accent);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Packs */
        .pack-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        body.dark .pack-card {
            background: #2a2a2a;
        }

        .pack-card:hover {
            transform: translateY(-5px);
        }

        .pack-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        .pack-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .pack-price {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .pack-rates {
            text-align: left;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .pack-rates div {
            margin: 0.3rem 0;
        }

        /* Library */
        .library-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .library-tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--primary);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        body.dark .library-tab {
            background: #2a2a2a;
        }

        .library-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Leaderboard */
        .leaderboard {
            max-width: 600px;
            margin: 2rem auto;
        }

        .leaderboard-item {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body.dark .leaderboard-item {
            background: #2a2a2a;
        }

        .leaderboard-item.first {
            border: 3px solid #f39c12;
        }

        .leaderboard-item.second {
            border: 3px solid #95a5a6;
        }

        .leaderboard-item.third {
            border: 3px solid #cd7f32;
        }

        .leaderboard-rank {
            font-size: 2rem;
            font-weight: 700;
            margin-right: 1rem;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .leaderboard-cailloux {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Admin Panel */
        .admin-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body.dark .admin-section {
            background: #2a2a2a;
        }

        .admin-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
        }

        body.dark .form-input,
        body.dark .form-select {
            background: #3a3a3a;
            border-color: #4a4a4a;
            color: white;
        }

        .user-list {
            margin-top: 1rem;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f5f5f5;
            margin-bottom: 0.5rem;
            border-radius: 8px;
        }

        body.dark .user-item {
            background: #3a3a3a;
        }

        /* Game Section */
        .game-wrapper {
            max-width: 900px;
            margin: 0 auto;
        }

        .game-stats {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body.dark .game-stats {
            background: #2a2a2a;
        }

        .game-stat {
            text-align: center;
        }

        .game-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .game-stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .score {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            color: #fff;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .game-over-screen, .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .game-over-screen {
            display: none;
        }

        .game-over-screen.show {
            display: flex;
        }

        .start-screen.hide {
            display: none;
        }

        .game-title {
            font-family: 'Playfair Display', serif;
            font-size: 72px;
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
        }

        .game-over-title {
            font-family: 'Playfair Display', serif;
            font-size: 64px;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-shadow: 0 4px 20px rgba(255, 107, 107, 0.5);
        }

        .final-score {
            font-size: 28px;
            color: #fff;
            margin-bottom: 30px;
        }

        .instructions {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
        }

        .start-btn, .restart-btn {
            font-family: 'Inter', sans-serif;
            font-size: 24px;
            font-weight: 600;
            padding: 18px 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4);
        }

        .restart-btn {
            font-size: 20px;
            padding: 15px 40px;
        }

        .start-btn:hover, .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.6);
        }

        .start-btn:active, .restart-btn:active {
            transform: translateY(0);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        body.dark .modal-content {
            background: #2a2a2a;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                gap: 1rem;
            }

            .hero h1 {
                font-size: 2rem;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
            }

            .game-container {
                height: 350px;
            }

            .game-title {
                font-size: 48px;
            }

            .game-over-title {
                font-size: 48px;
            }

            .score {
                font-size: 24px;
            }

            .nav-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">ü™® Jolie Pas Cher</div>
            <input type="text" class="login-input" id="username" placeholder="Email (utilis√© pour Firebase)">
            <input type="password" class="login-input" id="password" placeholder="Mot de passe">
            <button class="login-btn" onclick="login()">Se connecter</button>
            <button class="login-btn btn-secondary" style="margin-top: 0.5rem;" onclick="showSignup()">Cr√©er un compte</button>
            <div class="error-msg" id="errorMsg"></div>
        </div>
    </div>

    <nav>
        <div class="nav-container">
            <div class="logo">ü™® Jolie Pas Cher</div>
            <ul class="nav-links">
                <li><a onclick="showSection('home')">Accueil</a></li>
                <li><a onclick="showSection('shop')">Boutique</a></li>
                <li><a onclick="showSection('packs')">Packs</a></li>
                <li><a onclick="showSection('library')">Biblioth√®que</a></li>
                <li><a onclick="showSection('game')">Jeu</a></li>
                <li><a onclick="showSection('leaderboard')">Classement</a></li>
                <li id="adminLink" style="display: none;"><a onclick="showSection('admin')">Admin</a></li>
            </ul>
            <div class="user-info">
                <div class="cailloux-count">
                    ü™® <span id="userCailloux">0</span>
                </div>
                <span id="usernameDisplay"></span>
                <button class="logout-btn" onclick="logout()">D√©connexion</button>
            </div>
        </div>
    </nav>

    <div class="hero">
        <h1>ü™® Collectionnez des Cailloux !</h1>
        <p>Ouvrez des packs, jouez au jeu et collectionnez des objets rares</p>
    </div>

    <div class="container">
        <section id="home" class="section active">
            <h2>Bienvenue sur Jolie Pas Cher !</h2>
            <p style="margin-top: 1rem; color: var(--text-light); font-size: 1.1rem;">
                ü™® Achetez des packs pour collectionner des objets rares !<br>
                üéÆ Jouez au Caillou Dash pour gagner des cailloux !<br>
                üèÜ Grimpez au classement pour devenir le meilleur collectionneur !
            </p>
        </section>

        <section id="shop" class="section">
            <h2>üõçÔ∏è Boutique</h2>
            <div class="products-grid" id="shopGrid"></div>
        </section>

        <section id="packs" class="section">
            <h2>üì¶ Packs Myst√®re</h2>
            <div class="products-grid">
                <div class="pack-card">
                    <div class="pack-icon">üì¶</div>
                    <div class="pack-name">Pack Basique</div>
                    <div class="pack-price">50 ü™®</div>
                    <div class="pack-rates">
                        <div>üîò Nul: 50%</div>
                        <div>üîµ Basique: 30%</div>
                        <div>üü£ Rare: 19%</div>
                        <div>üü° GOAT: 1%</div>
                    </div>
                    <button class="btn" onclick="openPack(50)">Ouvrir</button>
                </div>
                <div class="pack-card">
                    <div class="pack-icon">üéÅ</div>
                    <div class="pack-name">Pack Premium</div>
                    <div class="pack-price">100 ü™®</div>
                    <div class="pack-rates">
                        <div>üîò Nul: 30%</div>
                        <div>üîµ Basique: 40%</div>
                        <div>üü£ Rare: 25%</div>
                        <div>üü° GOAT: 5%</div>
                    </div>
                    <button class="btn" onclick="openPack(100)">Ouvrir</button>
                </div>
                <div class="pack-card">
                    <div class="pack-icon">üíé</div>
                    <div class="pack-name">Pack Ultime</div>
                    <div class="pack-price">250 ü™®</div>
                    <div class="pack-rates">
                        <div>üîò Nul: 10%</div>
                        <div>üîµ Basique: 30%</div>
                        <div>üü£ Rare: 40%</div>
                        <div>üü° GOAT: 20%</div>
                    </div>
                    <button class="btn" onclick="openPack(250)">Ouvrir</button>
                </div>
            </div>
        </section>

        <section id="library" class="section">
            <h2>üìö Ma Biblioth√®que</h2>
            <div class="library-tabs">
                <button class="library-tab active" onclick="filterLibrary('all')">Tous</button>
                <button class="library-tab" onclick="filterLibrary('goat')">üü° GOAT</button>
                <button class="library-tab" onclick="filterLibrary('rare')">üü£ Rare</button>
                <button class="library-tab" onclick="filterLibrary('basique')">üîµ Basique</button>
                <button class="library-tab" onclick="filterLibrary('nul')">üîò Nul</button>
            </div>
            <div class="products-grid" id="libraryGrid"></div>
        </section>

        <section id="game" class="section">
            <div class="game-wrapper">
                <h2 style="text-align: center; margin-bottom: 1rem;">ü™® Caillou Dash</h2>
                <div class="game-stats">
                    <div class="game-stat">
                        <div class="game-stat-value" id="gameEarnings">0</div>
                        <div class="game-stat-label">Cailloux gagn√©s</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat-value" id="gameBestScore">0</div>
                        <div class="game-stat-label">Meilleur score</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat-value" id="gameAliveTime">0s</div>
                        <div class="game-stat-label">Temps de survie</div>
                    </div>
                </div>
                <div class="game-container">
                    <canvas id="gameCanvas"></canvas>

                    <div class="ui-overlay">
                        <div class="score" id="score">0</div>
                    </div>

                    <div class="start-screen" id="startScreen">
                        <div class="game-title">ü™® Caillou Dash</div>
                        <div class="instructions">
                            Cliquez ou appuyez pour sauter<br>
                            Gagnez 1 caillou toutes les 10 secondes !
                        </div>
                        <button class="start-btn" id="startBtn">Commencer</button>
                    </div>

                    <div class="game-over-screen" id="gameOverScreen">
                        <div class="game-over-title">Game Over!</div>
                        <div class="final-score">Score: <span id="finalScore">0</span></div>
                        <div class="final-score">ü™® Gagn√©s: <span id="finalEarnings">0</span></div>
                        <button class="restart-btn" id="restartBtn">Recommencer</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="leaderboard" class="section">
            <h2 style="text-align: center;">üèÜ Classement</h2>
            <div class="leaderboard" id="leaderboardList"></div>
        </section>

        <section id="admin" class="section">
            <div class="admin-section">
                <h3 class="admin-title">Ajouter un Produit</h3>
                <div class="form-group">
                    <label class="form-label">Nom du produit</label>
                    <input type="text" class="form-input" id="productName">
                </div>
                <div class="form-group">
                    <label class="form-label">Emoji</label>
                    <input type="text" class="form-input" id="productEmoji" placeholder="Ex: üéÆ">
                </div>
                <div class="form-group">
                    <label class="form-label">Prix (en cailloux)</label>
                    <input type="number" class="form-input" id="productPrice">
                </div>
                <div class="form-group">
                    <label class="form-label">Raret√©</label>
                    <select class="form-select" id="productRarity">
                        <option value="nul">üîò Nul</option>
                        <option value="basique">üîµ Basique</option>
                        <option value="rare">üü£ Rare</option>
                        <option value="goat">üü° GOAT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Dur√©e de vie (jours)</label>
                    <input type="number" class="form-input" id="productDuration" value="7" placeholder="Laisser vide pour permanent">
                </div>
                <button class="btn" onclick="addProduct()">Ajouter le Produit</button>
            </div>

            <div class="admin-section" id="ownerSection" style="display: none;">
                <h3 class="admin-title">G√©rer les Employ√©s (Owner uniquement)</h3>
                <div class="form-group">
                    <label class="form-label">Nom d'utilisateur</label>
                    <input type="text" class="form-input" id="employeeName">
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" class="form-input" id="employeePassword">
                </div>
                <div class="form-group">
                    <label class="form-label">Salaire (en cailloux)</label>
                    <input type="number" class="form-input" id="employeeSalary" value="500">
                </div>
                <div class="form-group">
                    <label class="form-label">R√¥le</label>
                    <select class="form-select" id="employeeRole">
                        <option value="employee">Employ√©</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="addEmployee()">Ajouter un Employ√©</button>

                <h4 style="margin-top: 2rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Liste des Employ√©s</h4>
                <div class="user-list" id="employeeList">
                    </div>
                <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="checkSalaries()">Payer les Salaires Maintenant</button>
            </div>

            <div class="admin-section">
                <h3 class="admin-title">G√©rer les Utilisateurs</h3>
                <div class="user-list" id="userList">
                    </div>
                <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="renderUserList()">Rafra√Æchir la Liste</button>
            </div>
        </section>

    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-buttons">
                <button class="btn" style="width: 50%;" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- NOUVELLE CONFIGURATION ET IMPORTS MODULAIRES ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            runTransaction, 
            query, 
            where, 
            orderBy, 
            limit, 
            getDocs, 
            FieldValue,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        // Votre configuration Firebase (utilis√©e pour initialiser l'app)
        const firebaseConfig = {
            apiKey: "AIzaSyDUztozKsSV8b1imdc9YWw0CL_RlPmIKPk",
            authDomain: "jolie-pas-cher.firebaseapp.com",
            projectId: "jolie-pas-cher",
            storageBucket: "jolie-pas-cher.firebasestorage.app",
            messagingSenderId: "835428667735",
            appId: "1:835428667735:web:19c9b0c1c1854fe80c2e12",
            measurementId: "G-XQ0WB0V8KQ"
        };

        // 1. Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const usersCollectionRef = collection(db, 'users');
        const productsCollectionRef = collection(db, 'products');

        // Variables de stockage en m√©moire pour l'√©tat actuel de l'utilisateur
        let currentUser = null; // ID de l'utilisateur (Firestore Doc ID)
        let currentUserData = null; // Donn√©es compl√®tes de l'utilisateur
        let shopProducts = []; // Cache des produits de la boutique
        let gameBestScore = 0; 

        // Rendre FieldValue disponible globalement si n√©cessaire, bien qu'il soit import√©
        const increment = FieldValue.increment;

        /**
         * Met √† jour le document de l'utilisateur actuel dans Firestore.
         * @param {object} data Les champs √† mettre √† jour.
         */
        async function updateUserDoc(data) {
            if (!currentUser) return;
            try {
                // Mettre √† jour l'objet local
                currentUserData = { ...currentUserData, ...data };
                // √âcrire sur Firestore
                await updateDoc(doc(db, 'users', currentUser), data);
                console.log("Document utilisateur mis √† jour avec succ√®s !");
            } catch (e) {
                console.error("Erreur lors de la mise √† jour du document utilisateur: ", e);
            }
        }

        // Variable pour basculer entre Login et Signup dans l'√©cran de connexion
        let isLoginMode = true;

        window.showSignup = function() { // Rendre ces fonctions globales
            isLoginMode = false;
            document.querySelector('.login-btn').textContent = 'Cr√©er le compte';
            document.querySelector('.login-btn').setAttribute('onclick', 'signup()');
            document.querySelector('.btn-secondary').textContent = 'Retour √† la connexion';
            document.querySelector('.btn-secondary').setAttribute('onclick', 'showLogin()');
            document.getElementById('errorMsg').textContent = '';
        }

        window.showLogin = function() { // Rendre ces fonctions globales
            isLoginMode = true;
            document.querySelector('.login-btn').textContent = 'Se connecter';
            document.querySelector('.login-btn').setAttribute('onclick', 'login()');
            document.querySelector('.btn-secondary').textContent = 'Cr√©er un compte';
            document.querySelector('.btn-secondary').setAttribute('onclick', 'showSignup()');
            document.getElementById('errorMsg').textContent = '';
        }

        // --- Fonctions de Connexion et Inscription ---

        window.logout = function() {
            currentUser = null;
            currentUserData = null;
            document.getElementById('adminLink').style.display = 'none';
            document.getElementById('ownerSection').style.display = 'none';
            document.getElementById('loginScreen').classList.remove('hide');
            showLogin(); // R√©initialiser l'√©cran √† la connexion
        }

        window.login = async function() {
            const usernameInput = document.getElementById('username');
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');

            if (!usernameInput.value || !password) {
                errorMsg.textContent = 'Veuillez remplir tous les champs';
                return;
            }

            // Convertir en majuscules pour une recherche insensible √† la casse
            // ATTENTION: La recherche est insensible √† la casse, donc 'HAR22FRA' ou 'har22fra' fonctionne.
            const username = usernameInput.value.trim().toUpperCase(); 

            errorMsg.textContent = 'Connexion en cours...';

            try {
                // 1. Chercher l'utilisateur dans Firestore (MODULAIRE)
                const userDocRef = doc(db, 'users', username);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const data = userDoc.data();

                    // 2. V√©rifier le mot de passe (Simple v√©rification en clair)
                    // ATTENTION: Le mot de passe est sensible √† la casse
                    if (data.password === password) { 
                        // 3. V√©rifier le bannissement
                        if (data.banned) {
                            errorMsg.textContent = 'Votre compte a √©t√© banni';
                            return;
                        }

                        // Succ√®s de la connexion
                        currentUser = username;
                        currentUserData = data;
                        document.getElementById('loginScreen').classList.add('hide');
                        document.getElementById('usernameDisplay').textContent = currentUser;

                        // Initialisation de l'UI
                        updateCaillouxDisplay();
                        if (currentUserData.bestScore) {
                            gameBestScore = currentUserData.bestScore;
                            document.getElementById('gameBestScore').textContent = gameBestScore;
                        }

                        if (data.role === 'admin' || data.role === 'owner') {
                            document.getElementById('adminLink').style.display = 'block';
                        }
                        
                        if (data.role === 'owner') {
                            document.getElementById('ownerSection').style.display = 'block';
                            renderEmployeeList();
                        }

                        // Chargement des donn√©es asynchrones
                        await fetchShopProducts();
                        renderLibrary();
                        renderLeaderboard();
                        checkSalaries(); // V√©rifier et payer les salaires

                    } else {
                        errorMsg.textContent = 'Nom d\'utilisateur ou mot de passe incorrect';
                    }
                } else {
                    errorMsg.textContent = 'Utilisateur non trouv√©. Cliquez sur "Cr√©er un compte".';
                }
            } catch (e) {
                console.error("Erreur de connexion:", e);
                errorMsg.textContent = 'Une erreur est survenue lors de la connexion. (Voir console)';
            }
        }

        // Nouvelle fonction pour l'inscription
        window.signup = async function() {
            const usernameInput = document.getElementById('username');
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');

            if (!usernameInput.value || !password) {
                errorMsg.textContent = 'Veuillez remplir tous les champs';
                return;
            }
            
            // Convertir en majuscules pour une cr√©ation d'utilisateur uniforme
            const username = usernameInput.value.trim().toUpperCase();

            try {
                const userDocRef = doc(db, 'users', username);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    errorMsg.textContent = 'Ce nom d\'utilisateur existe d√©j√†. Veuillez vous connecter.';
                    return;
                }

                // --- LOGIQUE ADMINISTRATEUR/PROPRI√âTAIRE CORRIG√âE ---
                let role = 'user';
                let cailloux = 50;

                // Si l'utilisateur s'appelle HAR22FRA, il devient le propri√©taire (Owner)
                if (username === 'HAR22FRA') { // <--- CORRECTION APPLIQU√âE ICI
                    role = 'owner';
                    cailloux = 10000;
                }
                // --- FIN DU CORRECTIF ADMINISTRATEUR ---

                // Cr√©ation du nouvel utilisateur dans Firestore (MODULAIRE)
                const newUser = {
                    password: password, // Sauvegarde du mot de passe (sensible √† la casse)
                    role: role, 
                    cailloux: cailloux, 
                    library: [],
                    banned: false,
                    bestScore: 0,
                };
                
                await setDoc(doc(db, 'users', username), newUser);
                
                errorMsg.textContent = 'Compte cr√©√© avec succ√®s ! Vous √™tes connect√©(e) !';
                
                // Connexion automatique
                currentUser = username;
                currentUserData = newUser;
                document.getElementById('loginScreen').classList.add('hide');
                document.getElementById('usernameDisplay').textContent = currentUser;
                updateCaillouxDisplay();

                // Afficher le lien Admin/Owner si besoin
                if (role === 'admin' || role === 'owner') {
                    document.getElementById('adminLink').style.display = 'block';
                }
                
                if (role === 'owner') {
                    document.getElementById('ownerSection').style.display = 'block';
                    renderEmployeeList();
                }

                await fetchShopProducts();
                renderLibrary();
                renderLeaderboard();
                checkSalaries(); 
            } catch (e) {
                console.error("Erreur d'inscription:", e);
                errorMsg.textContent = 'Une erreur est survenue lors de la cr√©ation du compte. (Voir console)';
            }
        }


        // --- Fonctions d'interface ---

        window.updateCaillouxDisplay = function() {
            if (currentUserData) {
                document.getElementById('userCailloux').textContent = currentUserData.cailloux;
            } else {
                document.getElementById('userCailloux').textContent = '0';
            }
        }

        window.showSection = function(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            if (sectionId === 'admin') {
                renderUserList();
            }
        }

        // --- Fonctions de la Boutique (Produits) ---
        function checkExpiredProducts() {
            const now = Date.now();
            shopProducts = shopProducts.filter(product => {
                if (product.expiresAt && product.expiresAt < now) {
                    return false;
                }
                return true;
            });
        }

        // Charger les produits de la boutique depuis Firestore (MODULAIRE)
        async function fetchShopProducts() {
            try {
                checkExpiredProducts();
                const snapshot = await getDocs(productsCollectionRef);
                shopProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderShop();
            } catch (e) {
                console.error("Erreur lors du chargement des produits:", e);
            }
        }

        // Rendu de la boutique
        function renderShop() {
            checkExpiredProducts();
            const grid = document.getElementById('shopGrid');
            if (shopProducts.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">Aucun produit disponible pour le moment</p>';
                return;
            }
            grid.innerHTML = shopProducts.map(product => {
                const daysLeft = product.expiresAt ? Math.ceil((product.expiresAt - Date.now()) / (1000 * 60 * 60 * 24)) : null;
                return `
                    <div class="product-card ${product.rarity}">
                        <div class="rarity-badge ${product.rarity}">${product.rarity}</div>
                        <div class="product-image">${product.emoji}</div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">${product.price} ü™®</div>
                            ${daysLeft ? `<div class="product-expires">Expire dans ${daysLeft} jours</div>` : ''}
                            <button class="btn" onclick="buyProduct('${product.id}')">Acheter</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Achat de Produit (avec transaction Firestore MODULAIRE)
        window.buyProduct = async function(productId) {
            if (!currentUserData) return;
            const product = shopProducts.find(p => p.id === productId);

            if (!product) {
                showModal('Erreur', 'Produit non trouv√©');
                return;
            }

            if (currentUserData.cailloux < product.price) {
                showModal('Pas assez de cailloux', 'Vous n\'avez pas assez de cailloux pour acheter cet objet.');
                return;
            }

            // D√©marrer la transaction (MODULAIRE)
            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, 'users', currentUser);
                    const userDoc = await transaction.get(userRef);

                    if (!userDoc.exists()) {
                        throw "User document does not exist!";
                    }

                    const currentCailloux = userDoc.data().cailloux;
                    if (currentCailloux < product.price) {
                        throw "Not enough cailloux in database.";
                    }

                    const newCailloux = currentCailloux - product.price;
                    const newLibrary = [...userDoc.data().library, {
                        name: product.name,
                        emoji: product.emoji,
                        rarity: product.rarity
                    }];

                    transaction.update(userRef, {
                        cailloux: newCailloux,
                        library: newLibrary
                    });

                    // Mise √† jour de l'√©tat local apr√®s transaction r√©ussie
                    currentUserData.cailloux = newCailloux;
                    currentUserData.library = newLibrary;
                    updateCaillouxDisplay();
                    renderLibrary();
                    showModal('Achat r√©ussi !', `Vous avez achet√© ${product.emoji} ${product.name} !`);
                });
            } catch (e) {
                console.error("Erreur dans la transaction d'achat:", e);
                if (e === "User document does not exist!") return; // Erreur g√©r√©e localement
                showModal('Erreur d\'achat', 'Une erreur est survenue lors de l\'achat. Veuillez r√©essayer.');
            }
        }

        // Ouverture de Pack (avec transaction Firestore MODULAIRE)
        window.openPack = async function(price) {
            if (!currentUserData) return;
            if (currentUserData.cailloux < price) {
                showModal('Pas assez de cailloux', 'Vous n\'avez pas assez de cailloux pour ouvrir ce pack.');
                return;
            }

            let rarity, rates;
            if (price === 50) {
                rates = [
                    { rarity: 'nul', chance: 50 },
                    { rarity: 'basique', chance: 30 },
                    { rarity: 'rare', chance: 19 },
                    { rarity: 'goat', chance: 1 }
                ];
            } else if (price === 100) {
                rates = [
                    { rarity: 'nul', chance: 30 },
                    { rarity: 'basique', chance: 40 },
                    { rarity: 'rare', chance: 25 },
                    { rarity: 'goat', chance: 5 }
                ];
            } else { // 250
                rates = [
                    { rarity: 'nul', chance: 10 },
                    { rarity: 'basique', chance: 30 },
                    { rarity: 'rare', chance: 40 },
                    { rarity: 'goat', chance: 20 }
                ];
            }

            const rand = Math.random() * 100;
            let cumulative = 0;
            for (const rate of rates) {
                cumulative += rate.chance;
                if (rand <= cumulative) {
                    rarity = rate.rarity;
                    break;
                }
            }

            const emojis = ['üéÆ', 'üé®', 'üé≠', 'üé™', 'üé¨', 'üé§', 'üéß', 'üéØ', 'üé≤', 'üé≥', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'üéº', 'üèÄ', '‚öΩ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üèâ', 'üé±', 'üèì', 'üè∏', 'ü•ä', 'ü•ã', 'ü•Ö', '‚õ≥', 'üèéÔ∏è', 'üèçÔ∏è', 'üö≤', 'üõ¥', 'üõπ', 'üõº', 'üöä', 'üöÇ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üöö', 'üöõ', 'üöú', 'üö¢', '‚õ¥Ô∏è', 'üõ•Ô∏è', 'üö§', 'üõ∂', '‚õµ', 'üöÅ', 'üõ©Ô∏è', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üöÄ', 'üõ∞Ô∏è', 'üîî', 'üîï', 'üì¢', 'üì£', 'üí¨', 'üí≠', 'üóØÔ∏è', 'üé∞', 'üÉè', 'üÄÑ', 'üé¥', 'üï∞Ô∏è', '‚åõ', '‚è≥', '‚åö', 'üì±', 'üì≤', 'üíª', 'üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üì∏', 'üì∑', 'üìπ', 'üé•', 'üí°', 'üî¶', 'üèÆ', 'üïØÔ∏è', 'üóëÔ∏è', 'üõ¢Ô∏è', 'üí∏', 'üí∞', 'üí≥', 'üìß', '‚úâÔ∏è', 'üì©', 'üì®', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üì¶', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üì¶', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üì¶', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üì¶'];
            const names = ['Caillou Rare', 'Pierre Pr√©cieuse', 'Fragment Antique', 'Jeton Secret', '√âclat Brillant', 'Morceau de M√©t√©ore', 'P√©pite d\'Or', 'Tr√©sor Cach√©', 'Sph√®re Mystique', 'Artefact Oubli√©'];
            
            const item = {
                name: names[Math.floor(Math.random() * names.length)],
                emoji: emojis[Math.floor(Math.random() * emojis.length)],
                rarity: rarity
            };

            // D√©marrer la transaction (MODULAIRE)
            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, 'users', currentUser);
                    const userDoc = await transaction.get(userRef);

                    if (!userDoc.exists()) {
                        throw "User document does not exist!";
                    }

                    const currentCailloux = userDoc.data().cailloux;
                    if (currentCailloux < price) {
                        throw "Not enough cailloux in database.";
                    }

                    const newCailloux = currentCailloux - price;
                    const newLibrary = [...userDoc.data().library, item];

                    transaction.update(userRef, {
                        cailloux: newCailloux,
                        library: newLibrary
                    });

                    // Mise √† jour de l'√©tat local apr√®s transaction r√©ussie
                    currentUserData.cailloux = newCailloux;
                    currentUserData.library = newLibrary;
                    updateCaillouxDisplay();
                    renderLibrary();
                    const rarityEmojis = { 'nul': 'üîò', 'basique': 'üîµ', 'rare': 'üü£', 'goat': 'üü°' };
                    showModal('Pack ouvert !', `Vous avez obtenu : ${rarityEmojis[rarity]} ${item.emoji} ${item.name} !`);
                });
            } catch (e) {
                console.error("Erreur dans la transaction d'ouverture de pack:", e);
                if (e === "User document does not exist!") return;
                showModal('Erreur d\'ouverture de pack', 'Une erreur est survenue. Veuillez r√©essayer.');
            }
        }

        // Rendu de la Biblioth√®que
        let currentFilter = 'all';

        window.filterLibrary = function(rarity) {
            currentFilter = rarity;
            document.querySelectorAll('.library-tab').forEach(tab => tab.classList.remove('active'));
            const targetButton = event ? event.currentTarget : document.querySelector(`.library-tab[onclick="filterLibrary('${rarity}')"]`) || document.querySelector('.library-tab');
            if (targetButton) {
                targetButton.classList.add('active');
            }
            renderLibrary();
        }

        window.renderLibrary = function() {
            if (!currentUserData) return;
            const grid = document.getElementById('libraryGrid');
            let items = currentUserData.library;

            if (currentFilter !== 'all') {
                items = items.filter(item => item.rarity === currentFilter);
            }

            // Tri par raret√©
            const rarityOrder = { 'goat': 0, 'rare': 1, 'basique': 2, 'nul': 3 };
            items.sort((a, b) => rarityOrder[a.rarity] - rarityOrder[b.rarity]);

            if (items.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">Aucun objet dans votre biblioth√®que</p>';
                return;
            }

            grid.innerHTML = items.map((item, index) => `
                <div class="product-card ${item.rarity}">
                    <div class="rarity-badge ${item.rarity}">${item.rarity}</div>
                    <div class="product-image">${item.emoji}</div>
                    <div class="product-info">
                        <div class="product-name">${item.name}</div>
                    </div>
                </div>
            `).join('');
        }

        // Rendu du Classement (Lecture de tous les utilisateurs - MODULAIRE)
        window.renderLeaderboard = async function() {
            try {
                const q = query(
                    usersCollectionRef, 
                    where('banned', '==', false), 
                    orderBy('cailloux', 'desc'), 
                    limit(3)
                );
                const snapshot = await getDocs(q);
                const leaderboard = snapshot.docs.map(doc => ({ username: doc.id, cailloux: doc.data().cailloux }));
                
                const list = document.getElementById('leaderboardList');
                const ranks = ['first', 'second', 'third'];

                list.innerHTML = leaderboard.map((data, index) => `
                    <div class="leaderboard-item ${ranks[index]}">
                        <div class="leaderboard-rank">#${index + 1}</div>
                        <div class="leaderboard-name">${data.username}</div>
                        <div class="leaderboard-cailloux">${data.cailloux} ü™®</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Erreur lors du chargement du classement:", e);
            }
        }


        // --- Fonctions Admin (Produits et Utilisateurs) ---

        // Ajouter un Produit (Admin/Owner - MODULAIRE)
        window.addProduct = async function() {
            if (!currentUserData || (currentUserData.role !== 'admin' && currentUserData.role !== 'owner')) return;
            const name = document.getElementById('productName').value;
            const emoji = document.getElementById('productEmoji').value;
            const price = parseInt(document.getElementById('productPrice').value);
            const rarity = document.getElementById('productRarity').value;
            const durationDays = document.getElementById('productDuration').value;

            if (!name || !emoji || isNaN(price) || price <= 0 || !rarity) {
                showModal('Erreur', 'Veuillez remplir tous les champs correctement.');
                return;
            }

            let expiresAt = null;
            if (durationDays && !isNaN(parseInt(durationDays))) {
                const durationMs = parseInt(durationDays) * 24 * 60 * 60 * 1000;
                expiresAt = Date.now() + durationMs;
            }

            try {
                const newDocRef = doc(productsCollectionRef); // Cr√©ation d'une r√©f√©rence sans ID
                const product = { name, emoji, price, rarity, expiresAt };
                await setDoc(newDocRef, product); // Envoi du produit
                fetchShopProducts(); // Recharger la boutique
                
                document.getElementById('productName').value = '';
                document.getElementById('productEmoji').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productDuration').value = '7';
                showModal('Produit ajout√©', 'Le produit a √©t√© ajout√© √† la boutique !');
            } catch (e) {
                console.error("Erreur lors de l'ajout du produit:", e);
                showModal('Erreur', "Impossible d'ajouter le produit.");
            }
        }

        // Ajouter un Employ√© (Owner seulement - MODULAIRE)
        window.addEmployee = async function() {
            if (!currentUserData || currentUserData.role !== 'owner') return;
            const name = document.getElementById('employeeName').value.trim().toUpperCase();
            const password = document.getElementById('employeePassword').value;
            const salary = parseInt(document.getElementById('employeeSalary').value);
            const role = document.getElementById('employeeRole').value;

            if (!name || !password || !salary) {
                showModal('Erreur', 'Veuillez remplir tous les champs');
                return;
            }

            try {
                const userDocRef = doc(db, 'users', name);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    showModal('Erreur', 'Cet utilisateur existe d√©j√†');
                    return;
                }

                await setDoc(userDocRef, {
                    password,
                    role,
                    cailloux: 0,
                    library: [],
                    banned: false,
                    salary // Ce champ est la cl√© pour √™tre consid√©r√© comme employ√©
                });
                renderEmployeeList();
                document.getElementById('employeeName').value = '';
                document.getElementById('employeePassword').value = '';
                document.getElementById('employeeSalary').value = '500';
                showModal('Employ√© ajout√©', `${name} a √©t√© ajout√© avec succ√®s !`);
            } catch (e) {
                console.error("Erreur lors de l'ajout de l'employ√©:", e);
                showModal('Erreur', "Impossible d'ajouter l'employ√©.");
            }
        }

        // Rendu de la Liste des Employ√©s (MODULAIRE)
        window.renderEmployeeList = async function() {
            if (!currentUserData || currentUserData.role !== 'owner') return;
            const list = document.getElementById('employeeList');
            try {
                // Chercher tous les utilisateurs ayant un champ 'salary' (MODULAIRE)
                const q = query(usersCollectionRef, where('salary', '>', 0));
                const snapshot = await getDocs(q);
                
                const employees = snapshot.docs
                    .filter(doc => doc.id !== currentUser) // Exclure l'Owner actuel
                    .map(doc => ({ username: doc.id, ...doc.data() }));

                list.innerHTML = employees.map(data => `
                    <div class="user-item">
                        <div>
                            <strong>${data.username}</strong> - ${data.salary} ü™®/mois
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Erreur lors du chargement de la liste des employ√©s:", e);
            }
        }


        // Rendu de la Liste des Utilisateurs (pour l'admin/owner - MODULAIRE)
        window.renderUserList = async function() {
            if (!currentUserData || (currentUserData.role !== 'admin' && currentUserData.role !== 'owner')) return;
            const list = document.getElementById('userList');
            try {
                const snapshot = await getDocs(usersCollectionRef);
                const userList = snapshot.docs
                    .filter(doc => {
                        const username = doc.id;
                        // Un Admin ne peut pas modifier un Owner
                        if (currentUserData.role === 'admin') {
                            return doc.data().role !== 'owner' && username !== currentUser;
                        } else {
                            // Un Owner peut tout voir sauf lui-m√™me
                            return username !== currentUser;
                        }
                    })
                    .map(doc => ({ username: doc.id, ...doc.data() }));

                list.innerHTML = userList.map(data => `
                    <div class="user-item">
                        <div>
                            <strong>${data.username}</strong> - ${data.cailloux} ü™® ${data.banned ? '(Banni)' : ''} 
                        </div>
                        <button class="btn ${data.banned ? 'btn-secondary' : 'btn-danger'}" style="width: auto;" onclick="toggleBan('${data.username}')">
                            ${data.banned ? 'D√©bannir' : 'Bannir'}
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Erreur lors du chargement de la liste des utilisateurs:", e);
            }
        }

        // Basculer le Bannissement (MODULAIRE)
        window.toggleBan = async function(username) {
            if (!currentUserData) return;
            const userDocRef = doc(db, 'users', username);
            const userDoc = await getDoc(userDocRef);
            if (!userDoc.exists()) return;
            const userData = userDoc.data();

            if (currentUserData.role === 'admin' && userData.role === 'owner') {
                showModal('Erreur', 'Vous ne pouvez pas bannir le propri√©taire');
                return;
            }

            const isBanned = !userData.banned;
            try {
                await updateDoc(userDocRef, { banned: isBanned });
                renderUserList();
                renderLeaderboard();
                showModal(isBanned ? 'Utilisateur banni' : 'Utilisateur d√©banni', `${username} a √©t√© ${isBanned ? 'banni' : 'd√©banni'} avec succ√®s.`);
            } catch (e) {
                console.error("Erreur lors du bannissement:", e);
            }
        }

        // V√©rifier et payer les salaires (MODULAIRE)
        window.checkSalaries = function() {
            const currentMonth = new Date().getMonth();
            const lastPayday = localStorage.getItem('lastPayday');

            if (lastPayday && parseInt(lastPayday) === currentMonth) {
                console.log("Les salaires ont d√©j√† √©t√© pay√©s ce mois-ci.");
                return;
            }

            const batch = writeBatch(db); // Utilisation de writeBatch modulaire
            const employeesQuery = query(usersCollectionRef, where('salary', '>', 0));
            
            getDocs(employeesQuery)
            .then(snapshot => {
                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const docRef = doc(db, 'users', docSnapshot.id);
                    // Utilisation de FieldValue.increment modulaire
                    batch.update(docRef, { cailloux: increment(data.salary) });

                    // Si c'est l'utilisateur actuel, mettre √† jour les donn√©es locales
                    if (docSnapshot.id === currentUser) {
                        currentUserData.cailloux += data.salary;
                        updateCaillouxDisplay();
                    }
                });
                return batch.commit();
            })
            .then(() => {
                localStorage.setItem('lastPayday', currentMonth);
                console.log("Paiement des salaires effectu√© pour tous les employ√©s !");
                renderLeaderboard();
                // Afficher le modal uniquement si les salaires viennent d'√™tre pay√©s
                if (!lastPayday || parseInt(lastPayday) !== currentMonth) {
                    showModal('Salaires pay√©s', 'Les salaires des employ√©s ont √©t√© pay√©s avec succ√®s.');
                }
            })
            .catch(e => {
                console.error("Erreur lors du paiement des salaires:", e);
                showModal('Erreur', "Erreur lors du paiement des salaires.");
            });
        }

        // Modal (rendu global)
        window.showModal = function(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').classList.add('show');
        }

        window.closeModal = function() {
            document.getElementById('modal').classList.remove('show');
        }

        // --- Game Code (Mise √† jour pour sauvegarder le score) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const scoreElement = document.getElementById('score');
        const finalScoreElement = document.getElementById('finalScore');
        const finalEarningsElement = document.getElementById('finalEarnings');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let gameRunning = false;
        let score = 0;
        let gameSpeed = 5;
        let gravity = 0.8;
        let gameStartTime = 0;
        let earnedCailloux = 0;
        // gameBestScore est initialis√© lors du login

        const player = {
            x: 100,
            y: 0,
            width: 40,
            height: 40,
            velocityY: 0,
            jumping: false,
            rotation: 0
        };

        const ground = {
            y: canvas.height - 80,
            height: 80
        };

        let obstacles = [];
        let obstacleTimer = 0;
        let obstacleInterval = 100;
        
        let clouds = [];
        for (let i = 0; i < 3; i++) {
            clouds.push({
                x: Math.random() * canvas.width,
                y: Math.random() * (canvas.height / 3),
                size: 20 + Math.random() * 20
            });
        }

        function jump() {
            if (!gameRunning || player.jumping) return;
            player.velocityY = -15; // Force de saut
            player.jumping = true;
        }

        function update() {
            if (!gameRunning) return;

            // Mettre √† jour les stats
            updateStats();

            // Mouvement du joueur
            player.velocityY += gravity;
            player.y += player.velocityY;
            player.rotation += 0.1 * gameSpeed; // Rotation pour le fun

            // Collision avec le sol
            const groundY = canvas.height - player.height - ground.height;
            if (player.y >= groundY) {
                player.y = groundY;
                player.velocityY = 0;
                player.jumping = false;
            }

            // Spawn d'obstacles
            obstacleTimer++;
            if (obstacleTimer >= obstacleInterval) {
                const height = 40; // Hauteur fixe de l'obstacle
                obstacles.push({
                    x: canvas.width,
                    y: canvas.height - height - ground.height,
                    width: 30 + Math.random() * 40,
                    height: height
                });
                obstacleInterval = 70 + Math.random() * 80; // Intervalle al√©atoire
                obstacleTimer = 0;
            }

            // Mouvement des obstacles et des nuages
            obstacles.forEach(obstacle => {
                obstacle.x -= gameSpeed;

                // V√©rification de la collision
                if (
                    player.x < obstacle.x + obstacle.width &&
                    player.x + player.width > obstacle.x &&
                    player.y + player.height > obstacle.y
                ) {
                    gameOver();
                }
            });

            clouds.forEach(cloud => {
                cloud.x -= gameSpeed * 0.2; // Vitesse des nuages plus lente
                if (cloud.x < -cloud.size * 3) {
                    cloud.x = canvas.width + cloud.size * 3;
                    cloud.y = Math.random() * (canvas.height / 3);
                    cloud.size = 20 + Math.random() * 20;
                }
            });

            // Supprimer les obstacles sortis de l'√©cran
            obstacles = obstacles.filter(obstacle => obstacle.x + obstacle.width > 0);

            // Mise √† jour du score
            score++;
            scoreElement.textContent = score;

            // Augmenter la difficult√©
            if (score % 500 === 0) {
                gameSpeed += 0.5;
            }
        }

        function drawRock() {
            ctx.save();
            ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
            ctx.rotate(player.rotation);
            
            // Dessin du Caillou (Rocher)
            const size = player.width;
            const isDark = document.body.classList.contains('dark');
            
            ctx.fillStyle = isDark ? '#a0a0a0' : '#666'; 
            ctx.beginPath();
            // Forme irr√©guli√®re simple
            ctx.moveTo(-size/2, 0);
            ctx.lineTo(-size/4, -size/2);
            ctx.lineTo(size/4, -size/2);
            ctx.lineTo(size/2, -size/4);
            ctx.lineTo(size/2, size/4);
            ctx.lineTo(size/4, size/2);
            ctx.lineTo(-size/4, size/2);
            ctx.closePath();
            ctx.fill();
            
            ctx.strokeStyle = isDark ? '#b0b0b0' : '#555';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Reflets/d√©tails
            ctx.fillStyle = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            ctx.beginPath();
            ctx.arc(-size/6, -size/6, size/8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        function drawObstacle(obstacle) {
            ctx.fillStyle = 'black'; // Pointes
            ctx.beginPath();
            const spikeWidth = obstacle.width / 3;
            
            for (let i = 0; i < 3; i++) {
                const x = obstacle.x + i * spikeWidth;
                ctx.moveTo(x, obstacle.y + obstacle.height);
                ctx.lineTo(x + spikeWidth / 2, obstacle.y);
                ctx.lineTo(x + spikeWidth, obstacle.y + obstacle.height);
            }
            ctx.closePath();
            ctx.fill();

            // Ombre
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(obstacle.x, obstacle.y + obstacle.height, obstacle.width, 5);
        }

        function drawGround() {
            const isDark = document.body.classList.contains('dark');
            ctx.fillStyle = isDark ? '#1e293b' : '#94a3b8';
            ctx.fillRect(0, ground.y, canvas.width, ground.height);

            ctx.fillStyle = isDark ? '#0f172a' : '#64748b';
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.fillRect(i, ground.y, 20, ground.height);
            }

            ctx.strokeStyle = isDark ? '#475569' : '#cbd5e1';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, ground.y);
            ctx.lineTo(canvas.width, ground.y);
            ctx.stroke();
        }

        function drawClouds() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            clouds.forEach(cloud => {
                ctx.beginPath();
                ctx.arc(cloud.x, cloud.y, 20, 0, Math.PI * 2);
                ctx.arc(cloud.x + 25, cloud.y, 25, 0, Math.PI * 2);
                ctx.arc(cloud.x + 50, cloud.y, 20, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function updateStats() {
            const timeElapsed = (Date.now() - gameStartTime) / 1000;
            document.getElementById('gameAliveTime').textContent = `${timeElapsed.toFixed(1)}s`;

            // Gagner 1 caillou toutes les 10 secondes (1 caillou / 600 frames √† 60fps, score ~ 600)
            const newEarnings = Math.floor(score / 600); 
            if (newEarnings > earnedCailloux) {
                earnedCailloux = newEarnings;
                document.getElementById('gameEarnings').textContent = earnedCailloux;
            }
        }

        function draw() {
            const isDark = document.body.classList.contains('dark');
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            if (isDark) {
                gradient.addColorStop(0, '#0f172a');
                gradient.addColorStop(1, '#1e293b');
            } else {
                gradient.addColorStop(0, '#87ceeb');
                gradient.addColorStop(1, '#e0f2fe');
            }
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawClouds();
            drawGround();
            obstacles.forEach(drawObstacle);
            drawRock();
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameRunning = true;
            score = 0;
            gameSpeed = 5;
            earnedCailloux = 0;
            obstacles = [];
            player.y = 0;
            player.velocityY = 0;
            gameStartTime = Date.now();
            document.getElementById('gameEarnings').textContent = '0';
            document.getElementById('gameAliveTime').textContent = '0s';
            startScreen.classList.add('hide');
            gameOverScreen.classList.remove('show');
        }

        async function gameOver() {
            gameRunning = false;
            finalScoreElement.textContent = score;
            finalEarningsElement.textContent = earnedCailloux;
            gameOverScreen.classList.add('show');

            if (!currentUser) return; // Ne pas sauvegarder si d√©connect√©

            let shouldUpdate = false;
            let dataToUpdate = {};

            if (score > gameBestScore) {
                gameBestScore = score;
                document.getElementById('gameBestScore').textContent = gameBestScore;
                dataToUpdate.bestScore = gameBestScore;
                shouldUpdate = true;
            }

            if (earnedCailloux > 0) {
                // Mise √† jour de l'√©tat local
                currentUserData.cailloux += earnedCailloux;
                updateCaillouxDisplay();
                
                // Pr√©paration de la mise √† jour Firestore (champ incr√©mental)
                dataToUpdate.cailloux = increment(earnedCailloux); // Utilisation de FieldValue.increment modulaire
                shouldUpdate = true;
            }

            if (shouldUpdate) {
                // Utiliser la fonction pour √©crire sur Firestore (un seul appel)
                await updateUserDoc(dataToUpdate); 
                renderLeaderboard();
            }
        }

        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);

        canvas.addEventListener('click', jump);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                jump();
            }
        });

        gameLoop();

        // Initialisation - Lancer la v√©rification d'expiration et le chargement des produits
        setInterval(checkExpiredProducts, 60000);
        // fetchShopProducts sera appel√© apr√®s la connexion pour garantir que la boutique est pr√™te.
    </script>
</body>
</html>